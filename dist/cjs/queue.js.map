{"version":3,"sources":["../../src/queue.js"],"names":["CLEANUP_JOB_TYPE","PRIORITY_OFFSET","Math","floor","Number","MAX_SAFE_INTEGER","BatteryQueue","options","stopped","dequeueQueue","PQueue","concurrency","unloadQueue","handlerMap","Map","cleanupMap","durationEstimateHandlerMap","durationEstimateMap","durationEstimateUpdaterMap","retryJobDelayMap","retryCleanupDelayMap","queueCurrentJobTypeMap","queueMap","jobIds","Set","abortControllerMap","isClearing","emitCallbacks","logger","addListener","error","errorStack","interval","clearTimeout","heartbeatExpiresTimeout","heartbeatExpiresTimestamp","Date","now","round","setTimeout","warn","unloadClient","queueId","jobId","queueAbortControllerMap","get","abortController","abort","disableStartOnJob","didRequestJobAddDequeue","handleJobAdd","self","queueMicrotask","dequeue","jobEmitter","handleJobDelete","id","abortJob","handleJobUpdate","type","status","JOB_CLEANUP_AND_REMOVE_STATUS","JOB_CLEANUP_STATUS","didAbort","then","job","has","args","startCleanup","catch","removeListener","emitCallback","queueIds","keys","handleUnload","Error","retryJobDelayFunction","set","delete","attempt","result","emit","retryCleanupDelayFunction","handler","cleanup","timeEstimationHandler","duration","pending","queueDurationEstimateMap","emitDurationEstimate","values","updateDurationEstimate","totalDuration","totalPending","getDurationEstimate","onIdle","start","priority","autoStart","func","queue","add","newQueue","on","setCurrentJobType","undefined","Promise","resolve","timeout","handleClearing","handleActive","size","info","removeDurationEstimate","jobs","startJobs","lastJobId","addToQueue","bind","newJobs","Array","isArray","startAfter","pause","JOB_PENDING_STATUS","startJob","JOB_ERROR_STATUS","startErrorHandler","stopPromise","idlePromises","setInterval","isPaused","clear","push","finally","clearInterval","all","maxDuration","onIdlePromise","jobsInterval","length","newAbortController","AbortController","cleanupJob","data","delay","toLocaleString","path","name","getRetryCleanupDelay","retryCleanupDelay","newStartAfter","runCleanup","run","getAbortController","signal","aborted","removeAbortController","AbortError","reject","removeEventListener","handleAbort","addEventListener","updateCleanupData","updateDuration","addDurationEstimate","durationEstimateHandler","durationEstimate","handlerDidRun","delayJobStart","shouldKeepJobInDatabase","estimatedToActualRatio","abortQueue","getRetryJobDelay","retryDelay","event","MessageEvent","warnObject","port","requestId","requestArgs","stop","MessagePort","onmessage","abortAndRemoveQueueJobsGreaterThanId","abortAndRemoveQueue","updateDurationEstimates","retryQueue","enableStartOnJob","getQueueIds","currentJobType","getCurrentJobType","runUnloadHandlers","handleHeartbeat","unloadData","activeEmitCallback","handleJobsClear","tag","lastChance","waitUntil","ExtendableMessageEvent","ports","filter","x","previousPort","close","localJobEmitter","handlePortMessage","postMessage","t","errorObject","EventEmitter"],"mappings":"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","sourcesContent":["// @flow\n\nimport PQueue from 'p-queue';\nimport EventEmitter from 'events';\nimport type { Logger } from './logger';\nimport makeLogger from './logger';\nimport type { Job } from './database';\nimport {\n  jobEmitter,\n  localJobEmitter,\n  clearDatabase,\n  dequeueFromDatabase,\n  dequeueFromDatabaseNotIn,\n  incrementJobAttemptInDatabase,\n  incrementCleanupAttemptInDatabase,\n  markJobCompleteInDatabase,\n  markJobCompleteThenRemoveFromDatabase,\n  markJobPendingInDatabase,\n  markJobErrorInDatabase,\n  markJobStartAfterInDatabase,\n  markJobAsAbortedOrRemoveFromDatabase,\n  markCleanupStartAfterInDatabase,\n  markQueuePendingInDatabase,\n  updateCleanupValuesInDatabase,\n  getCleanupFromDatabase,\n  removePathFromCleanupDataInDatabase,\n  getJobFromDatabase,\n  markQueueForCleanupInDatabase,\n  markQueueForCleanupAndRemoveInDatabase,\n  markQueueJobsGreaterThanIdCleanupAndRemoveInDatabase,\n  removeCleanupFromDatabase,\n  restoreJobToDatabaseForCleanupAndRemove,\n  getUnloadDataFromDatabase,\n  clearUnloadDataInDatabase,\n  getGreatestJobIdFromQueueInDatabase,\n  JOB_PENDING_STATUS,\n  JOB_ERROR_STATUS,\n  JOB_CLEANUP_STATUS,\n  JOB_CLEANUP_AND_REMOVE_STATUS,\n} from './database';\nimport { AbortError } from './errors';\n\nexport const CLEANUP_JOB_TYPE = 'CLEANUP_JOB_TYPE';\n\nconst PRIORITY_OFFSET = Math.floor(Number.MAX_SAFE_INTEGER / 2);\n\ntype HandlerFunction = (Array<any>, AbortSignal, (Object) => Promise<void>, (number, number) => void) => Promise<void | false>;\ntype CleanupFunction = (Object | void, Array<any>, Array<string> => Promise<void>) => Promise<void>;\ntype DurationEstimateFunction = (Array<any>) => number;\ntype RetryDelayFunction = (number, Error) => number | false | Promise<number | false>;\ntype EmitCallback = (string, Array<any>) => void;\ntype UnloadFunction = (Object | void) => Promise<void> | void;\n\ntype Options = {\n  logger?: Logger,\n  startOnJob?: boolean\n};\n\nexport default class BatteryQueue extends EventEmitter {\n  declare logger: Logger;\n  declare dequeueQueue: PQueue;\n  declare unloadQueue: PQueue;\n  declare handlerMap: Map<string, HandlerFunction>;\n  declare retryJobDelayMap: Map<string, RetryDelayFunction>;\n  declare retryCleanupDelayMap: Map<string, RetryDelayFunction>;\n  declare cleanupMap: Map<string, CleanupFunction>;\n  declare queueCurrentJobTypeMap: Map<string, string>;\n  declare durationEstimateHandlerMap: Map<string, DurationEstimateFunction>;\n  declare durationEstimateMap: Map<string, Map<number, [number, number]>>;\n  declare durationEstimateUpdaterMap: Map<number, () => number>;\n  declare queueMap: Map<string, PQueue>;\n  declare handleUnload: void | UnloadFunction;\n  declare abortControllerMap: Map<string, Map<number, AbortController>>;\n  declare isClearing: boolean;\n  declare onIdlePromise: Promise<void> | void;\n  declare stopPromise: Promise<void> | void;\n  declare jobIds: Set<number>;\n\n  declare emitCallbacks: Array<EmitCallback>;\n  declare port: MessagePort | void;\n  declare handleJobAdd: void | () => void;\n  declare handleJobUpdate: void | (number, string, string, number) => void;\n  declare handleJobDelete: void | (number, string) => void;\n  declare heartbeatExpiresTimestamp: void | number;\n  declare heartbeatExpiresTimeout: void | TimeoutID;\n  declare stopped: boolean;\n\n  constructor(options?: Options = {}) {\n    super();\n    this.stopped = false;\n    this.dequeueQueue = new PQueue({ concurrency: 1 });\n    this.unloadQueue = new PQueue({ concurrency: 1 });\n    this.handlerMap = new Map();\n    this.cleanupMap = new Map();\n    this.durationEstimateHandlerMap = new Map();\n    this.durationEstimateMap = new Map();\n    this.durationEstimateUpdaterMap = new Map();\n    this.retryJobDelayMap = new Map();\n    this.retryCleanupDelayMap = new Map();\n    this.queueCurrentJobTypeMap = new Map();\n    this.queueMap = new Map();\n    this.jobIds = new Set();\n    this.durationEstimateUpdaterMap = new Map();\n    this.abortControllerMap = new Map();\n    this.isClearing = false;\n    this.emitCallbacks = [];\n    this.logger = options.logger || makeLogger('Battery Queue');\n    this.addListener('error', (error) => {\n      this.logger.errorStack(error);\n    });\n    this.addListener('heartbeat', (interval:number) => {\n      clearTimeout(this.heartbeatExpiresTimeout);\n      this.heartbeatExpiresTimestamp = Date.now() + Math.round(interval * 2.5);\n      this.heartbeatExpiresTimeout = setTimeout(() => {\n        if (typeof this.heartbeatExpiresTimestamp !== 'number') {\n          return;\n        }\n        this.logger.warn(`Heartbeat timeout after ${Math.round(interval * 2.1)}ms`);\n        this.unloadClient();\n      }, Math.round(interval * 2.1));\n    });\n  }\n\n  abortJob(queueId:string, jobId:number) {\n    const queueAbortControllerMap = this.abortControllerMap.get(queueId);\n    if (typeof queueAbortControllerMap !== 'undefined') {\n      const abortController = queueAbortControllerMap.get(jobId);\n      if (typeof abortController !== 'undefined') {\n        abortController.abort();\n        return true;\n      }\n    }\n    return false;\n  }\n\n  enableStartOnJob() {\n    this.disableStartOnJob(); // Prevent handlers from being added multiple times\n    let didRequestJobAddDequeue = false;\n    const handleJobAdd = () => {\n      if (didRequestJobAddDequeue) {\n        return;\n      }\n      didRequestJobAddDequeue = true;\n      self.queueMicrotask(() => {\n        didRequestJobAddDequeue = false;\n        this.dequeue();\n      });\n    };\n    jobEmitter.addListener('jobAdd', handleJobAdd);\n    this.handleJobAdd = handleJobAdd;\n    const handleJobDelete = (id:number, queueId:string) => {\n      this.abortJob(queueId, id);\n    };\n    jobEmitter.addListener('jobDelete', handleJobDelete);\n    this.handleJobDelete = handleJobDelete;\n\n    const handleJobUpdate = (id:number, queueId:string, type:string, status:number) => {\n      if (status !== JOB_CLEANUP_AND_REMOVE_STATUS && status !== JOB_CLEANUP_STATUS) {\n        return;\n      }\n      const didAbort = this.abortJob(queueId, id);\n      if (didAbort) {\n        return;\n      }\n      getJobFromDatabase(id).then((job:Job | void) => {\n        if (typeof job === 'undefined') {\n          this.logger.error(`Unable to cleanup and remove ${type} job #${id} in queue ${queueId}, job does not exist`);\n          return;\n        }\n        if (this.jobIds.has(id)) {\n          return;\n        }\n        const { args } = job;\n        this.startCleanup(id, queueId, args, type, true);\n      }).catch((error) => {\n        this.logger.error(`Error while cleaning up and removing ${type} job #${id} in queue ${queueId}`);\n        this.logger.errorStack(error);\n      });\n    };\n    jobEmitter.addListener('jobUpdate', handleJobUpdate);\n    this.handleJobUpdate = handleJobUpdate;\n  }\n\n  disableStartOnJob() {\n    const handleJobAdd = this.handleJobAdd;\n    if (typeof handleJobAdd === 'function') {\n      jobEmitter.removeListener('jobAdd', handleJobAdd);\n      delete this.handleJobAdd;\n    }\n    const handleJobUpdate = this.handleJobUpdate;\n    if (typeof handleJobUpdate === 'function') {\n      jobEmitter.removeListener('jobUpdate', handleJobUpdate);\n      delete this.handleJobUpdate;\n    }\n    const handleJobDelete = this.handleJobDelete;\n    if (typeof handleJobDelete === 'function') {\n      jobEmitter.removeListener('jobDelete', handleJobDelete);\n      delete this.handleJobDelete;\n    }\n  }\n\n  emit(type:string, ...args:Array<any>) {\n    for (const emitCallback of this.emitCallbacks) {\n      emitCallback(type, args);\n    }\n    return super.emit(type, ...args);\n  }\n\n  async getQueueIds() {\n    await this.dequeue();\n    const queueIds:Set<string> = new Set(this.queueMap.keys());\n    return queueIds;\n  }\n\n  setUnload(handleUnload:UnloadFunction) {\n    if (typeof this.handleUnload === 'function') {\n      throw new Error('Unload handler already exists');\n    }\n    this.handleUnload = handleUnload;\n  }\n\n  removeUnload() {\n    if (typeof this.handleUnload !== 'function') {\n      throw new Error('Unload handler does not exist');\n    }\n    delete this.handleUnload;\n  }\n\n  setRetryJobDelay(type:string, retryJobDelayFunction:RetryDelayFunction) {\n    if (this.retryJobDelayMap.has(type)) {\n      throw new Error(`Retry job delay handler for type \"${type}\" already exists`);\n    }\n    this.retryJobDelayMap.set(type, retryJobDelayFunction);\n  }\n\n  removeRetryJobDelay(type:string) {\n    if (!this.retryJobDelayMap.has(type)) {\n      throw new Error(`Retry job delay handler for type \"${type}\" does not exist`);\n    }\n    this.retryJobDelayMap.delete(type);\n  }\n\n  async getRetryJobDelay(type:string, attempt: number, error:Error) {\n    const retryJobDelayFunction = this.retryJobDelayMap.get(type);\n    if (typeof retryJobDelayFunction !== 'function') {\n      return false;\n    }\n    let result = false;\n    try {\n      result = await retryJobDelayFunction(attempt, error);\n    } catch (retryDelayError) {\n      this.logger.error(`Error in retry job delay handler for type \"${type}\" on attempt ${attempt}`);\n      this.emit('error', retryDelayError);\n      return false;\n    }\n    if (typeof result !== 'number' && result !== false) {\n      throw new Error(`Retry job delay function for type \"${type}\" returned invalid response, should be a number (milliseconds) or false`);\n    }\n    return result;\n  }\n\n  setRetryCleanupDelay(type:string, retryCleanupDelayFunction:RetryDelayFunction) {\n    if (this.retryCleanupDelayMap.has(type)) {\n      throw new Error(`Retry cleanup delay handler for type \"${type}\" already exists`);\n    }\n    this.retryCleanupDelayMap.set(type, retryCleanupDelayFunction);\n  }\n\n  removeRetryCleanupDelay(type:string) {\n    if (!this.retryCleanupDelayMap.has(type)) {\n      throw new Error(`Retry cleanup delay handler for type \"${type}\" does not exist`);\n    }\n    this.retryCleanupDelayMap.delete(type);\n  }\n\n  async getRetryCleanupDelay(type:string, attempt: number, error:Error) {\n    const retryCleanupDelayFunction = this.retryCleanupDelayMap.get(type);\n    if (typeof retryCleanupDelayFunction !== 'function') {\n      return false;\n    }\n    let result = false;\n    try {\n      result = await retryCleanupDelayFunction(attempt, error);\n    } catch (retryDelayError) {\n      this.logger.error(`Error in retry cleanup delay handler for type \"${type}\" on attempt ${attempt}`);\n      this.emit('error', retryDelayError);\n      return false;\n    }\n    if (typeof result !== 'number' && result !== false) {\n      throw new Error(`Retry cleanup delay function for type \"${type}\" returned invalid response, should be a number (milliseconds) or false`);\n    }\n    return result;\n  }\n\n  setHandler(type:string, handler: HandlerFunction) {\n    if (this.handlerMap.has(type)) {\n      throw new Error(`Handler for type \"${type}\" already exists`);\n    }\n    this.handlerMap.set(type, handler);\n  }\n\n  removeHandler(type:string) {\n    if (!this.handlerMap.has(type)) {\n      throw new Error(`Handler for type \"${type}\" does not exist`);\n    }\n    this.handlerMap.delete(type);\n  }\n\n  setCleanup(type:string, cleanup: CleanupFunction) {\n    if (this.cleanupMap.has(type)) {\n      throw new Error(`Cleanup for type \"${type}\" already exists`);\n    }\n    this.cleanupMap.set(type, cleanup);\n  }\n\n  removeCleanup(type:string) {\n    if (!this.cleanupMap.has(type)) {\n      throw new Error(`Cleanup for type \"${type}\" does not exist`);\n    }\n    this.cleanupMap.delete(type);\n  }\n\n  setDurationEstimateHandler(type:string, timeEstimationHandler: DurationEstimateFunction) {\n    if (this.durationEstimateHandlerMap.has(type)) {\n      throw new Error(`Time estimation handler for type \"${type}\" already exists`);\n    }\n    this.durationEstimateHandlerMap.set(type, timeEstimationHandler);\n  }\n\n  removeDurationEstimateHandler(type:string) {\n    if (!this.durationEstimateHandlerMap.has(type)) {\n      throw new Error(`Time estimation handler for type \"${type}\" does not exist`);\n    }\n    this.durationEstimateHandlerMap.delete(type);\n  }\n\n  addDurationEstimate(queueId:string, jobId:number, duration:number, pending:number) {\n    const queueDurationEstimateMap = this.durationEstimateMap.get(queueId);\n    if (typeof queueDurationEstimateMap === 'undefined') {\n      this.durationEstimateMap.set(queueId, new Map([[jobId, [duration, pending]]]));\n      this.emitDurationEstimate(queueId);\n      return;\n    }\n    queueDurationEstimateMap.set(jobId, [duration, pending]);\n    this.emitDurationEstimate(queueId);\n  }\n\n  removeDurationEstimate(queueId:string, jobId?:number) {\n    if (typeof jobId !== 'number') {\n      this.durationEstimateMap.delete(queueId);\n      this.emitDurationEstimate(queueId);\n      return;\n    }\n    const queueDurationEstimateMap = this.durationEstimateMap.get(queueId);\n    if (typeof queueDurationEstimateMap === 'undefined') {\n      this.emitDurationEstimate(queueId);\n      return;\n    }\n    queueDurationEstimateMap.delete(jobId);\n    this.emitDurationEstimate(queueId);\n  }\n\n  updateDurationEstimates() {\n    for (const updateDurationEstimate of this.durationEstimateUpdaterMap.values()) {\n      updateDurationEstimate();\n    }\n  }\n\n  getDurationEstimate(queueId:string) {\n    const queueDurationEstimateMap = this.durationEstimateMap.get(queueId);\n    let totalDuration = 0;\n    let totalPending = 0;\n    if (typeof queueDurationEstimateMap === 'undefined') {\n      return [totalDuration, totalPending];\n    }\n    for (const [duration, pending] of queueDurationEstimateMap.values()) {\n      totalDuration += duration;\n      totalPending += pending;\n    }\n    return [totalDuration, totalPending];\n  }\n\n  emitDurationEstimate(queueId:string) {\n    const [totalDuration, totalPending] = this.getDurationEstimate(queueId);\n    this.emit('queueDuration', queueId, totalDuration, totalPending);\n  }\n\n  setCurrentJobType(queueId:string, type?:void | string) {\n    if (typeof type === 'string') {\n      this.queueCurrentJobTypeMap.set(queueId, type);\n    } else {\n      this.queueCurrentJobTypeMap.delete(queueId);\n    }\n    this.emit('queueJobType', queueId, type);\n  }\n\n  getCurrentJobType(queueId:string) {\n    return this.queueCurrentJobTypeMap.get(queueId);\n  }\n\n  async clear() {\n    this.isClearing = true;\n    await this.onIdle();\n    this.emit('clearing');\n    await clearDatabase();\n    this.dequeueQueue.start();\n    this.isClearing = false;\n  }\n\n  addToQueue(queueId:string, priority: number, autoStart: boolean, func: () => Promise<void>) {\n    if (this.stopped) {\n      return;\n    }\n    const queue = this.queueMap.get(queueId);\n    if (typeof queue !== 'undefined') {\n      queue.add(func, { priority });\n      return;\n    }\n    const newQueue = new PQueue({ concurrency: 1, autoStart });\n    this.queueMap.set(queueId, newQueue);\n    newQueue.add(func, { priority });\n    newQueue.on('idle', async () => {\n      this.setCurrentJobType(queueId, undefined);\n      if (!this.isClearing) {\n        await new Promise((resolve) => {\n          const timeout = setTimeout(() => {\n            this.removeListener('clearing', handleClearing);\n            newQueue.removeListener('active', handleActive);\n            resolve();\n          }, 5000);\n          const handleClearing = () => {\n            clearTimeout(timeout);\n            this.removeListener('clearing', handleClearing);\n            newQueue.removeListener('active', handleActive);\n            resolve();\n          };\n          const handleActive = () => {\n            clearTimeout(timeout);\n            this.removeListener('clearing', handleClearing);\n            newQueue.removeListener('active', handleActive);\n            resolve();\n          };\n          this.addListener('clearing', handleClearing);\n          newQueue.addListener('active', handleActive);\n        });\n      }\n      if (newQueue.pending > 0 || newQueue.size > 0) {\n        return;\n      }\n      this.queueMap.delete(queueId);\n      this.emit('queueInactive', queueId);\n    });\n    this.emit('queueActive', queueId);\n  }\n\n  async abortQueue(queueId: string) {\n    this.logger.info(`Aborting queue ${queueId}`);\n    this.removeDurationEstimate(queueId);\n    // Abort active jobs\n    const queueAbortControllerMap = this.abortControllerMap.get(queueId);\n    if (typeof queueAbortControllerMap !== 'undefined') {\n      for (const abortController of queueAbortControllerMap.values()) {\n        abortController.abort();\n      }\n    }\n    // Changes:\n    // * JOB_ERROR_STATUS -> JOB_CLEANUP_STATUS\n    // * JOB_COMPLETE_STATUS -> JOB_CLEANUP_STATUS\n    // * JOB_CLEANUP_AND_REMOVE_STATUS -> JOB_CLEANUP_AND_REMOVE_STATUS\n    // * JOB_PENDING_STATUS -> JOB_ABORTED_STATUS\n    const jobs = await markQueueForCleanupInDatabase(queueId);\n    await this.startJobs(jobs);\n  }\n\n  async retryQueue(queueId: string) {\n    this.logger.info(`Retrying queue ${queueId}`);\n    const lastJobId = await getGreatestJobIdFromQueueInDatabase(queueId);\n    const priority = PRIORITY_OFFSET - lastJobId - 0.5;\n    this.addToQueue(queueId, priority, true, async () => {\n      // Resets job attempts. Changes:\n      // * JOB_ABORTED_STATUS -> JOB_PENDING_STATUS\n      // * JOB_ERROR_STATUS -> JOB_ERROR_STATUS\n      // * JOB_CLEANUP_STATUS -> JOB_CLEANUP_STATUS\n      // * JOB_COMPLETE_STATUS -> JOB_COMPLETE_STATUS\n      // * JOB_CLEANUP_AND_REMOVE_STATUS -> JOB_CLEANUP_AND_REMOVE_STATUS\n      const jobs = await markQueuePendingInDatabase(queueId);\n      await this.startJobs(jobs);\n    });\n  }\n\n  async abortAndRemoveQueue(queueId: string) {\n    this.logger.info(`Aborting and removing queue ${queueId}`);\n    this.removeDurationEstimate(queueId);\n    // Abort active jobs\n    const queueAbortControllerMap = this.abortControllerMap.get(queueId);\n    if (typeof queueAbortControllerMap !== 'undefined') {\n      for (const abortController of queueAbortControllerMap.values()) {\n        abortController.abort();\n      }\n    }\n    // Changes:\n    // * JOB_ERROR_STATUS -> JOB_CLEANUP_AND_REMOVE_STATUS\n    // * JOB_COMPLETE_STATUS -> JOB_CLEANUP_AND_REMOVE_STATUS\n    // * JOB_CLEANUP_STATUS -> JOB_CLEANUP_AND_REMOVE_STATUS\n    // * JOB_CLEANUP_AND_REMOVE_STATUS -> JOB_CLEANUP_AND_REMOVE_STATUS\n    // * Removes other statuses\n    const jobs = await markQueueForCleanupAndRemoveInDatabase(queueId);\n    await this.startJobs(jobs);\n  }\n\n  async abortAndRemoveQueueJobsGreaterThanId(queueId: string, id: number) {\n    this.logger.info(`Aborting and removing jobs with ID greater than ${id} in queue ${queueId}`);\n    // Abort active jobs\n    const queueAbortControllerMap = this.abortControllerMap.get(queueId);\n    if (typeof queueAbortControllerMap !== 'undefined') {\n      for (const [jobId, abortController] of queueAbortControllerMap) {\n        if (jobId > id) {\n          this.removeDurationEstimate(queueId, jobId);\n          abortController.abort();\n        }\n      }\n    }\n    // Changes:\n    // * JOB_ERROR_STATUS -> JOB_CLEANUP_AND_REMOVE_STATUS\n    // * JOB_COMPLETE_STATUS -> JOB_CLEANUP_AND_REMOVE_STATUS\n    // * JOB_CLEANUP_STATUS -> JOB_CLEANUP_AND_REMOVE_STATUS\n    // * JOB_CLEANUP_AND_REMOVE_STATUS -> JOB_CLEANUP_AND_REMOVE_STATUS\n    // * Removes other statuses\n    const jobs = await markQueueJobsGreaterThanIdCleanupAndRemoveInDatabase(queueId, id);\n    await this.startJobs(jobs);\n  }\n\n  async dequeue():Promise<void> {\n    if (this.stopped) {\n      return;\n    }\n    if (this.dequeueQueue.size === 0) {\n      // Add a subsequent dequeue\n      this.dequeueQueue.add(this.startJobs.bind(this));\n    }\n    await this.dequeueQueue.onIdle();\n  }\n\n  async startJobs(newJobs?:Array<Job>) { // eslint-disable-line consistent-return\n    const jobs = Array.isArray(newJobs) ? newJobs : await dequeueFromDatabaseNotIn([...this.jobIds.keys()]);\n    const queueIds = new Set();\n    for (const { id, queueId, args, type, status, attempt, startAfter } of jobs) {\n      if (this.jobIds.has(id)) {\n        continue;\n      }\n      // Pause queues before adding items into them to avoid starting things out of priority\n      if (!queueIds.has(queueId)) {\n        const queue = this.queueMap.get(queueId);\n        if (typeof queue !== 'undefined') {\n          queue.pause();\n        }\n        queueIds.add(queueId);\n      }\n      if (status === JOB_PENDING_STATUS) {\n        this.startJob(id, queueId, args, type, attempt + 1, startAfter, false);\n      } else if (status === JOB_ERROR_STATUS) {\n        this.startErrorHandler(id, queueId, args, type, attempt, startAfter, false);\n      } else if (status === JOB_CLEANUP_STATUS) {\n        this.startCleanup(id, queueId, args, type, false);\n      } else if (status === JOB_CLEANUP_AND_REMOVE_STATUS) {\n        this.startCleanup(id, queueId, args, type, false);\n      } else {\n        throw new Error(`Unknown job status ${status} in job ${id} of queue ${queueId}`);\n      }\n    }\n    for (const queueId of queueIds) {\n      const queue = this.queueMap.get(queueId);\n      if (typeof queue !== 'undefined') {\n        queue.start();\n      } else {\n        this.logger.error(`Unable to start queue ${queueId} after dequeue; queue does not exist`);\n      }\n    }\n  }\n\n  async stop() {\n    if (typeof this.stopPromise === 'undefined') {\n      this.stopped = true;\n      this.stopPromise = (async () => {\n        await this.dequeueQueue.onIdle();\n        const idlePromises = [];\n        for (const [queueId, queue] of this.queueMap) {\n          const interval = setInterval(() => {\n            this.logger.info(`Waiting on queue ${queueId} stop() request. Queue ${queue.isPaused ? 'is paused' : 'is not paused'}, with ${queue.pending} ${queue.pending === 1 ? 'job' : 'jobs'} pending and ${queue.size} ${queue.size === 1 ? 'job' : 'jobs'} remaining.`);\n          }, 250);\n          queue.clear();\n          idlePromises.push(queue.onIdle().finally(() => {\n            clearInterval(interval);\n          }));\n        }\n        await Promise.all(idlePromises);\n        this.jobIds.clear();\n        this.abortControllerMap.clear();\n        delete this.stopPromise;\n        this.emit('stop');\n        this.stopped = false;\n      })();\n    }\n    await this.stopPromise;\n  }\n\n  async onIdle(maxDuration?: number) {\n    if (typeof this.onIdlePromise === 'undefined') {\n      this.onIdlePromise = (async () => {\n        const timeout = typeof maxDuration === 'number' ? Date.now() + maxDuration : -1;\n        const start = Date.now();\n        while (true) { // eslint-disable-line no-constant-condition\n          if (timeout !== -1 && Date.now() > timeout) {\n            this.logger.warn(`Idle timeout after ${Date.now() - start}ms`);\n            break;\n          }\n          await this.dequeueQueue.onIdle();\n          for (const [queueId, queue] of this.queueMap) {\n            const interval = setInterval(() => {\n              this.logger.info(`Waiting on queue ${queueId} onIdle() request. Queue ${queue.isPaused ? 'is paused' : 'is not paused'}, with ${queue.pending} ${queue.pending === 1 ? 'job' : 'jobs'} pending and ${queue.size} ${queue.size === 1 ? 'job' : 'jobs'} remaining.`);\n            }, 250);\n            await queue.onIdle();\n            clearInterval(interval);\n          }\n          const jobsInterval = setInterval(() => {\n            this.logger.info('Waiting on jobs');\n          }, 250);\n          const jobs = await dequeueFromDatabase();\n          clearInterval(jobsInterval);\n          if (jobs.length > 0) {\n            const interval = setInterval(() => {\n              this.logger.info('Waiting on dequeue');\n            }, 250);\n            await this.dequeue();\n            clearInterval(interval);\n            continue;\n          }\n          break;\n        }\n        delete this.onIdlePromise;\n        this.emit('idle');\n      })();\n    }\n    await this.onIdlePromise;\n  }\n\n  getAbortController(id:number, queueId:string) {\n    let queueAbortControllerMap = this.abortControllerMap.get(queueId);\n    if (typeof queueAbortControllerMap === 'undefined') {\n      queueAbortControllerMap = new Map();\n      this.abortControllerMap.set(queueId, queueAbortControllerMap);\n    }\n    const abortController = queueAbortControllerMap.get(id);\n    if (typeof abortController !== 'undefined') {\n      return abortController;\n    }\n    const newAbortController = new AbortController();\n    queueAbortControllerMap.set(id, newAbortController);\n    return newAbortController;\n  }\n\n  removeAbortController(id:number, queueId:string) {\n    const queueAbortControllerMap = this.abortControllerMap.get(queueId);\n    if (typeof queueAbortControllerMap === 'undefined') {\n      this.logger.warn(`Abort controller map for ${id} in queue ${queueId} does not exist`);\n      return;\n    }\n    const abortController = queueAbortControllerMap.get(id);\n    if (typeof abortController === 'undefined') {\n      this.logger.warn(`Abort controller for ${id} in queue ${queueId} does not exist`);\n      return;\n    }\n    queueAbortControllerMap.delete(id);\n    if (queueAbortControllerMap.size === 0) {\n      this.abortControllerMap.delete(queueId);\n    }\n  }\n\n  async runCleanup(id:number, queueId:string, args:Array<any>, type:string) {\n    this.emit('cleanupStart', { id });\n    const cleanup = this.cleanupMap.get(type);\n    if (typeof cleanup !== 'function') {\n      this.logger.warn(`No cleanup for job type ${type}`);\n      await removeCleanupFromDatabase(id);\n      this.emit('cleanup', { id });\n      return;\n    }\n    const cleanupJob = await getCleanupFromDatabase(id);\n    const { data, startAfter } = typeof cleanupJob === 'undefined' ? { data: undefined, startAfter: 0 } : cleanupJob;\n    const delay = startAfter - Date.now();\n    if (delay > 0) {\n      this.logger.info(`Delaying retry of ${type} job #${id} cleanup in queue ${queueId} by ${delay}ms to ${new Date(startAfter).toLocaleString()}`);\n      await new Promise((resolve) => setTimeout(resolve, delay));\n    }\n    try {\n      await cleanup(data, args, (path:Array<string>) => removePathFromCleanupDataInDatabase(id, path));\n    } catch (error) {\n      const attempt = await incrementCleanupAttemptInDatabase(id, queueId);\n      if (error.name === 'FatalError') {\n        this.logger.error(`Fatal error in ${type} job #${id} cleanup in queue ${queueId} attempt ${attempt}`);\n        this.emit('error', error);\n        await removeCleanupFromDatabase(id);\n        this.emit('fatalCleanupError', { id, queueId });\n        return;\n      }\n      const retryCleanupDelay = await this.getRetryCleanupDelay(type, attempt, error);\n      if (retryCleanupDelay === false) {\n        this.logger.error(`Error in ${type} job #${id} cleanup in queue ${queueId} attempt ${attempt} with no additional attempts requested`);\n        this.emit('error', error);\n        await removeCleanupFromDatabase(id);\n        this.emit('fatalCleanupError', { id, queueId });\n        return;\n      }\n      this.logger.error(`Error in ${type} job #${id} cleanup in queue ${queueId} attempt ${attempt}, retrying ${retryCleanupDelay > 0 ? `in ${retryCleanupDelay}ms` : 'immediately'}`);\n      this.emit('error', error);\n      if (retryCleanupDelay > 0) {\n        this.emit('retryCleanupDelay', { id, queueId, retryCleanupDelay });\n        const newStartAfter = Date.now() + retryCleanupDelay;\n        await markCleanupStartAfterInDatabase(id, newStartAfter);\n      }\n      await this.runCleanup(id, queueId, args, type);\n      return;\n    }\n    await removeCleanupFromDatabase(id);\n    this.emit('cleanup', { id });\n  }\n\n  startCleanup(id:number, queueId:string, args:Array<any>, type:string, autoStart:boolean) {\n    this.logger.info(`Adding ${type} cleanup job #${id} to queue ${queueId}`);\n    this.jobIds.add(id);\n    this.removeDurationEstimate(queueId, id);\n    const priority = PRIORITY_OFFSET + id;\n    const run = async () => {\n      this.setCurrentJobType(queueId, CLEANUP_JOB_TYPE);\n      this.logger.info(`Starting ${type} cleanup #${id} in queue ${queueId}`);\n      await this.runCleanup(id, queueId, args, type);\n      // Job could be marked for removal while cleanup is running\n      await markJobAsAbortedOrRemoveFromDatabase(id);\n      this.jobIds.delete(id);\n    };\n    this.addToQueue(queueId, priority, autoStart, run);\n  }\n\n  startErrorHandler(id:number, queueId:string, args:Array<any>, type:string, attempt: number, startAfter: number, autoStart:boolean) {\n    this.logger.info(`Adding ${type} error handler job #${id} to queue ${queueId}`);\n    this.jobIds.add(id);\n    const priority = PRIORITY_OFFSET + id;\n    const abortController = this.getAbortController(id, queueId);\n    const run = async () => {\n      this.setCurrentJobType(queueId, CLEANUP_JOB_TYPE);\n      this.logger.info(`Starting ${type} error handler #${id} in queue ${queueId}`);\n      await this.runCleanup(id, queueId, args, type);\n      if (abortController.signal.aborted) {\n        // Job could be marked for removal while error handler is running\n        await markJobAsAbortedOrRemoveFromDatabase(id);\n        this.removeAbortController(id, queueId);\n        this.jobIds.delete(id);\n      } else {\n        await markJobPendingInDatabase(id);\n        this.logger.info(`Retrying ${type} job #${id} in queue ${queueId}`);\n        this.emit('retry', { id });\n        this.startJob(id, queueId, args, type, attempt + 1, startAfter, true);\n      }\n      this.logger.info(`Completed ${type} error handler #${id} in queue ${queueId}`);\n    };\n    this.addToQueue(queueId, priority, autoStart, run);\n  }\n\n  async delayJobStart(id:number, queueId:string, type:string, signal: AbortSignal, startAfter: number) {\n    if (signal.aborted) {\n      throw new AbortError(`Queue ${queueId} was aborted`);\n    }\n    const duration = startAfter - Date.now();\n    if (duration > 0) {\n      this.logger.info(`Delaying start of ${type} job #${id} in queue ${queueId} by ${duration}ms`);\n      await new Promise((resolve, reject) => {\n        const timeout = setTimeout(() => {\n          signal.removeEventListener('abort', handleAbort);\n          resolve();\n        }, duration);\n        const handleAbort = () => {\n          clearTimeout(timeout);\n          signal.removeEventListener('abort', handleAbort);\n          reject(new AbortError(`Queue ${queueId} was aborted`));\n        };\n        signal.addEventListener('abort', handleAbort);\n      });\n    }\n  }\n\n  startJob(id:number, queueId:string, args:Array<any>, type:string, attempt:number, startAfter: number, autoStart:boolean) {\n    this.logger.info(`Adding ${type} job #${id} to queue ${queueId}`);\n    this.jobIds.add(id);\n    const priority = PRIORITY_OFFSET - id;\n    const updateCleanupData = (data:Object) => updateCleanupValuesInDatabase(id, queueId, data);\n    const updateDuration = (duration:number, pending:number) => {\n      this.addDurationEstimate(queueId, id, duration, pending);\n    };\n    const updateDurationEstimate = () => {\n      const durationEstimateHandler = this.durationEstimateHandlerMap.get(type);\n      if (typeof durationEstimateHandler === 'function') {\n        try {\n          const durationEstimate = durationEstimateHandler(args);\n          this.addDurationEstimate(queueId, id, durationEstimate, durationEstimate);\n          return durationEstimate;\n        } catch (error) {\n          this.logger.error(`Unable to estimate duration of ${type} job #${id} in queue ${queueId}`);\n          this.logger.errorStack(error);\n        }\n      }\n      return 0;\n    };\n    updateDurationEstimate();\n    this.durationEstimateUpdaterMap.set(id, updateDurationEstimate);\n    const abortController = this.getAbortController(id, queueId);\n    const run = async () => {\n      const start = Date.now();\n      const durationEstimate = updateDurationEstimate();\n      this.durationEstimateUpdaterMap.delete(id);\n      if (abortController.signal.aborted) {\n        this.emit('fatalError', { id, queueId, error: new AbortError(`Queue ${queueId} was aborted`) });\n        this.removeAbortController(id, queueId);\n        this.jobIds.delete(id);\n        this.removeDurationEstimate(queueId, id);\n        return;\n      }\n      const handler = this.handlerMap.get(type);\n      if (typeof handler !== 'function') {\n        this.logger.warn(`No handler for job type ${type}`);\n        await markJobCompleteInDatabase(id);\n        this.removeAbortController(id, queueId);\n        this.jobIds.delete(id);\n        this.addDurationEstimate(queueId, id, Date.now() - start, 0);\n        return;\n      }\n      this.setCurrentJobType(queueId, type);\n      let handlerDidRun = false;\n      try {\n        // Mark as error in database so the job is cleaned up and retried if execution\n        // stops before job completion or error.\n        await markJobErrorInDatabase(id);\n        await this.delayJobStart(id, queueId, type, abortController.signal, startAfter);\n        this.logger.info(`Starting ${type} job #${id} in queue ${queueId} attempt ${attempt}`);\n        handlerDidRun = true;\n        const shouldKeepJobInDatabase = await handler(args, abortController.signal, updateCleanupData, updateDuration);\n        if (abortController.signal.aborted) {\n          throw new AbortError(`Queue ${queueId} was aborted`);\n        }\n        if (shouldKeepJobInDatabase === false) {\n          await markJobCompleteThenRemoveFromDatabase(id);\n        } else {\n          await markJobCompleteInDatabase(id);\n        }\n        this.removeAbortController(id, queueId);\n        this.jobIds.delete(id);\n        const duration = Date.now() - start;\n        if (typeof durationEstimate === 'number') {\n          const estimatedToActualRatio = durationEstimate / duration;\n          if (estimatedToActualRatio < 0.8 || estimatedToActualRatio > 1.25) {\n            this.logger.warn(`Duration estimate of ${type} job #${id} (${durationEstimate}ms) was ${Math.round(100 * estimatedToActualRatio)}% of actual value (${duration}ms)`);\n          }\n        }\n        this.addDurationEstimate(queueId, id, duration, 0);\n        this.logger.info(`Completed ${type} job #${id} in queue ${queueId} attempt ${attempt} in ${duration}ms`);\n        return;\n      } catch (error) {\n        if (error.name === 'JobDoesNotExistError') {\n          this.logger.error(`Job does not exist error for ${type} job #${id} in queue ${queueId} attempt ${attempt}`);\n          if (handlerDidRun) {\n            this.emit('fatalError', { id, queueId, error });\n            await restoreJobToDatabaseForCleanupAndRemove(id, queueId, type, args);\n            this.jobIds.delete(id);\n            this.removeAbortController(id, queueId);\n            this.startCleanup(id, queueId, args, type, true);\n          } else {\n            this.emit('fatalError', { id, queueId, error });\n            this.jobIds.delete(id);\n            this.removeAbortController(id, queueId);\n            this.removeDurationEstimate(queueId, id);\n          }\n          return;\n        }\n        if (abortController.signal.aborted) {\n          if (error.name !== 'AbortError') {\n            this.logger.error(`Abort signal following error in ${type} job #${id} in queue ${queueId} attempt ${attempt}`);\n            this.emit('error', error);\n          } else {\n            this.logger.warn(`Received abort signal for ${type} job #${id} in queue ${queueId} attempt ${attempt}`);\n          }\n          if (handlerDidRun) {\n            this.emit('fatalError', { id, queueId, error });\n            this.jobIds.delete(id);\n            this.removeAbortController(id, queueId);\n            this.startCleanup(id, queueId, args, type, true);\n          } else {\n            this.emit('fatalError', { id, queueId, error });\n            await markJobAsAbortedOrRemoveFromDatabase(id);\n            this.jobIds.delete(id);\n            this.removeAbortController(id, queueId);\n            this.removeDurationEstimate(queueId, id);\n          }\n          return;\n        }\n        await incrementJobAttemptInDatabase(id);\n        if (error.name === 'FatalError') {\n          this.logger.error(`Fatal error in ${type} job #${id} in queue ${queueId} attempt ${attempt}`);\n          this.emit('error', error);\n          this.emit('fatalError', { id, queueId, error });\n          this.jobIds.delete(id);\n          this.removeAbortController(id, queueId);\n          await this.abortQueue(queueId);\n          return;\n        }\n        const retryDelay = await this.getRetryJobDelay(type, attempt, error);\n        if (retryDelay === false) {\n          this.logger.error(`Error in ${type} job #${id} in queue ${queueId} attempt ${attempt} with no additional attempts requested`);\n          this.emit('error', error);\n          this.emit('fatalError', { id, queueId, error });\n          this.jobIds.delete(id);\n          this.removeAbortController(id, queueId);\n          await this.abortQueue(queueId);\n          return;\n        }\n        this.logger.error(`Error in ${type} job #${id} in queue ${queueId} attempt ${attempt}, retrying ${retryDelay > 0 ? `in ${retryDelay}ms` : 'immediately'}`);\n        this.emit('error', error);\n        if (retryDelay > 0) {\n          this.emit('retryDelay', { id, queueId, retryDelay });\n          const newStartAfter = Date.now() + retryDelay;\n          await markJobStartAfterInDatabase(id, newStartAfter);\n          this.jobIds.delete(id);\n          this.startErrorHandler(id, queueId, args, type, attempt, newStartAfter, true);\n        } else {\n          this.jobIds.delete(id);\n          this.startErrorHandler(id, queueId, args, type, attempt, startAfter, true);\n        }\n      }\n    };\n    this.addToQueue(queueId, priority, autoStart, run);\n    this.emit('dequeue', { id });\n  }\n\n  async handlePortMessage(event:MessageEvent) {\n    if (!(event instanceof MessageEvent)) {\n      return;\n    }\n    const { data } = event;\n    if (!data || typeof data !== 'object') {\n      this.logger.warn('Invalid message data');\n      this.logger.warnObject(event);\n      return;\n    }\n    const { type, args } = data;\n    if (typeof type !== 'string') {\n      this.logger.warn('Unknown message type');\n      this.logger.warnObject(event);\n      return;\n    }\n    if (!Array.isArray(args)) {\n      this.logger.warn('Unknown arguments type');\n      this.logger.warnObject(event);\n      return;\n    }\n    const port = this.port;\n    switch (type) {\n      case 'heartbeat':\n        this.emit('heartbeat', ...args);\n        return;\n      case 'jobAdd':\n        jobEmitter.emit('jobAdd', ...args);\n        return;\n      case 'jobDelete':\n        jobEmitter.emit('jobDelete', ...args);\n        return;\n      case 'jobUpdate':\n        jobEmitter.emit('jobUpdate', ...args);\n        return;\n      case 'jobsClear':\n        jobEmitter.emit('jobsClear', ...args);\n        return;\n      default:\n        break;\n    }\n    const [requestId, ...requestArgs] = args;\n    if (typeof requestId !== 'number') {\n      throw new Error('Request arguments should start with a requestId number');\n    }\n    switch (type) {\n      case 'unlink':\n        this.logger.warn('Unlinking worker interface');\n        try {\n          await this.stop();\n          this.emit('unlinkComplete', requestId);\n        } catch (error) {\n          this.emit('unlinkError', requestId, error);\n          this.logger.error('Unable to handle unlink message');\n          this.emit('error', error);\n        }\n        if (port instanceof MessagePort) {\n          port.onmessage = null;\n          delete this.port;\n        }\n        break;\n      case 'clear':\n        try {\n          await this.clear();\n          this.emit('clearComplete', requestId);\n        } catch (error) {\n          this.emit('clearError', requestId, error);\n          this.logger.error('Unable to handle clear message');\n          this.emit('error', error);\n        }\n        break;\n      case 'abortAndRemoveQueueJobsGreaterThanId':\n        try {\n          const [queueId, id] = requestArgs;\n          if (typeof queueId !== 'string') {\n            throw new Error(`Invalid \"queueId\" argument with type ${typeof queueId}, should be type string`);\n          }\n          if (typeof id !== 'number') {\n            throw new Error(`Invalid \"id\" argument with type ${typeof id}, should be type number`);\n          }\n          await this.abortAndRemoveQueueJobsGreaterThanId(queueId, id);\n          this.emit('abortAndRemoveQueueJobsGreaterThanIdComplete', requestId);\n        } catch (error) {\n          this.emit('abortAndRemoveQueueJobsGreaterThanIdError', requestId, error);\n          this.logger.error('Unable to handle abort and remove queue jobs greater than ID message');\n          this.emit('error', error);\n        }\n        break;\n      case 'abortAndRemoveQueue':\n        try {\n          const [queueId] = requestArgs;\n          if (typeof queueId !== 'string') {\n            throw new Error(`Invalid \"queueId\" argument with type ${typeof queueId}, should be type string`);\n          }\n          await this.abortAndRemoveQueue(queueId);\n          this.emit('abortAndRemoveQueueComplete', requestId);\n        } catch (error) {\n          this.emit('abortAndRemoveQueueError', requestId, error);\n          this.logger.error('Unable to handle abort and remove queue message');\n          this.emit('error', error);\n        }\n        break;\n      case 'updateDurationEstimates':\n        try {\n          await this.updateDurationEstimates();\n          this.emit('updateDurationEstimatesComplete', requestId);\n        } catch (error) {\n          this.emit('updateDurationEstimatesError', requestId, error);\n          this.logger.error('Unable to handle update duration estimates message');\n          this.emit('error', error);\n        }\n        break;\n      case 'abortQueue':\n        try {\n          const [queueId] = requestArgs;\n          if (typeof queueId !== 'string') {\n            throw new Error(`Invalid \"queueId\" argument with type ${typeof queueId}, should be type string`);\n          }\n          await this.abortQueue(queueId);\n          this.emit('abortQueueComplete', requestId);\n        } catch (error) {\n          this.emit('abortQueueError', requestId, error);\n          this.logger.error('Unable to handle abort queue message');\n          this.emit('error', error);\n        }\n        break;\n      case 'retryQueue':\n        try {\n          const [queueId] = requestArgs;\n          if (typeof queueId !== 'string') {\n            throw new Error(`Invalid \"queueId\" argument with type ${typeof queueId}, should be type string`);\n          }\n          await this.retryQueue(queueId);\n          this.emit('retryQueueComplete', requestId);\n        } catch (error) {\n          this.emit('retryQueueError', requestId, error);\n          this.logger.error('Unable to handle retry queue message');\n          this.emit('error', error);\n        }\n        break;\n      case 'dequeue':\n        try {\n          await this.dequeue();\n          this.emit('dequeueComplete', requestId);\n        } catch (error) {\n          this.emit('dequeueError', requestId, error);\n          this.logger.error('Unable to handle dequeue message');\n          this.emit('error', error);\n        }\n        break;\n      case 'enableStartOnJob':\n        try {\n          this.enableStartOnJob();\n          this.emit('enableStartOnJobComplete', requestId);\n        } catch (error) {\n          this.emit('enableStartOnJobError', requestId, error);\n          this.logger.error('Unable to handle enableStartOnJob message');\n          this.emit('error', error);\n        }\n        break;\n      case 'disableStartOnJob':\n        try {\n          this.disableStartOnJob();\n          this.emit('disableStartOnJobComplete', requestId);\n        } catch (error) {\n          this.emit('disableStartOnJobError', requestId, error);\n          this.logger.error('Unable to handle disableStartOnJob message');\n          this.emit('error', error);\n        }\n        break;\n      case 'getQueueIds':\n        try {\n          const queueIds = await this.getQueueIds();\n          this.emit('getQueuesComplete', requestId, [...queueIds]);\n        } catch (error) {\n          this.emit('getQueuesError', requestId, error);\n          this.logger.error('Unable to handle getQueueIds message');\n          this.emit('error', error);\n        }\n        break;\n      case 'getDurationEstimate':\n        try {\n          const [queueId] = requestArgs;\n          if (typeof queueId !== 'string') {\n            throw new Error(`Invalid \"queueId\" argument with type ${typeof queueId}, should be type string`);\n          }\n          const values = await this.getDurationEstimate(queueId);\n          this.emit('getDurationEstimateComplete', requestId, values);\n        } catch (error) {\n          this.emit('getDurationEstimateError', requestId, error);\n          this.logger.error('Unable to handle get duration estimate message');\n          this.emit('error', error);\n        }\n        break;\n      case 'getCurrentJobType':\n        try {\n          const [queueId] = requestArgs;\n          if (typeof queueId !== 'string') {\n            throw new Error(`Invalid \"queueId\" argument with type ${typeof queueId}, should be type string`);\n          }\n          const currentJobType = this.getCurrentJobType(queueId);\n          this.emit('getCurrentJobTypeComplete', requestId, currentJobType);\n        } catch (error) {\n          this.emit('getCurrentJobTypeError', requestId, error);\n          this.logger.error('Unable to handle get current job type message');\n          this.emit('error', error);\n        }\n        break;\n      case 'runUnloadHandlers':\n        try {\n          await this.runUnloadHandlers();\n          this.emit('runUnloadHandlersComplete', requestId);\n        } catch (error) {\n          this.emit('runUnloadHandlersError', requestId, error);\n          this.logger.error('Unable to run unload handlers message');\n          this.emit('error', error);\n        }\n        break;\n      case 'idle':\n        try {\n          const [maxDuration, start] = requestArgs;\n          if (typeof maxDuration !== 'number') {\n            throw new Error(`Invalid \"queueId\" argument with type ${typeof maxDuration}, should be type number`);\n          }\n          if (typeof start !== 'number') {\n            throw new Error(`Invalid \"queueId\" argument with type ${typeof start}, should be type number`);\n          }\n          await this.onIdle(maxDuration - (Date.now() - start));\n          this.emit('idleComplete', requestId);\n        } catch (error) {\n          this.emit('idleError', requestId, error);\n          this.logger.error('Unable to handle idle message');\n          this.emit('error', error);\n        }\n        break;\n      default:\n        this.logger.warn(`Unknown worker interface message type ${type}`);\n    }\n  }\n\n  async unloadClient() {\n    this.logger.info('Detected client unload');\n    const heartbeatExpiresTimestamp = this.heartbeatExpiresTimestamp;\n    if (typeof heartbeatExpiresTimestamp !== 'number') {\n      return;\n    }\n    clearTimeout(this.heartbeatExpiresTimeout);\n    delete this.heartbeatExpiresTimestamp;\n    const delay = heartbeatExpiresTimestamp - Date.now();\n    if (delay > 0) {\n      await new Promise((resolve) => {\n        const timeout = setTimeout(() => {\n          clearTimeout(timeout);\n          this.removeListener('heartbeat', handleHeartbeat);\n          resolve();\n        }, delay);\n        const handleHeartbeat = () => {\n          clearTimeout(timeout);\n          this.removeListener('heartbeat', handleHeartbeat);\n          resolve();\n        };\n        this.addListener('heartbeat', handleHeartbeat);\n      });\n    }\n    if (typeof this.heartbeatExpiresTimestamp === 'number') {\n      this.logger.info('Cancelling client unload, heartbeat detected');\n      return;\n    }\n    this.logger.info('Unloading');\n    await this.runUnloadHandlers();\n    this.emit('unloadClient');\n    await this.onIdle();\n  }\n\n  runUnloadHandlers() {\n    return this.unloadQueue.add(async () => {\n      const handleUnload = this.handleUnload;\n      if (typeof handleUnload === 'function') {\n        try {\n          const unloadData = await getUnloadDataFromDatabase();\n          await handleUnload(unloadData);\n          await clearUnloadDataInDatabase();\n        } catch (error) {\n          this.logger.error('Error in unload handler');\n          this.logger.errorStack(error);\n        }\n      }\n    });\n  }\n\n  listenForServiceWorkerInterface() {\n    let activeEmitCallback;\n    let handleJobAdd;\n    let handleJobDelete;\n    let handleJobUpdate;\n    let handleJobsClear;\n\n    self.addEventListener('sync', (event) => {\n      this.logger.info(`SyncManager event ${event.tag}${event.lastChance ? ', last chance' : ''}`);\n      if (event.tag === 'syncManagerOnIdle') {\n        this.logger.info('Starting SyncManager idle handler');\n        this.emit('syncManagerOnIdle');\n        event.waitUntil(this.onIdle().catch((error) => {\n          this.logger.error(`SyncManager event handler failed${event.lastChance ? ' on last chance' : ''}`);\n          this.logger.errorStack(error);\n        }));\n      } else if (event.tag === 'unload') {\n        this.logger.info('Starting SyncManager unload client handler');\n        event.waitUntil(this.unloadClient().catch((error) => {\n          this.logger.error(`SyncManager event handler failed${event.lastChance ? ' on last chance' : ''}`);\n          this.logger.errorStack(error);\n        }));\n      } else {\n        this.logger.warn(`Received unknown SyncManager event tag ${event.tag}`);\n      }\n    });\n\n    self.addEventListener('message', (event:ExtendableMessageEvent) => {\n      if (!(event instanceof ExtendableMessageEvent)) {\n        return;\n      }\n      const { data } = event;\n      if (!data || typeof data !== 'object') {\n        return;\n      }\n      const { type } = data;\n      if (type !== 'BATTERY_QUEUE_WORKER_INITIALIZATION') {\n        return;\n      }\n      if (!Array.isArray(event.ports)) {\n        return;\n      }\n      const port = event.ports[0];\n      if (!(port instanceof MessagePort)) {\n        return;\n      }\n      this.emitCallbacks = this.emitCallbacks.filter((x) => x !== activeEmitCallback);\n      const previousPort = this.port;\n      if (previousPort instanceof MessagePort) {\n        this.logger.info('Closing previous worker interface');\n        previousPort.close();\n      }\n      if (typeof handleJobAdd === 'function') {\n        localJobEmitter.removeListener('jobAdd', handleJobAdd);\n      }\n      if (typeof handleJobDelete === 'function') {\n        localJobEmitter.removeListener('jobDelete', handleJobDelete);\n      }\n      if (typeof handleJobUpdate === 'function') {\n        localJobEmitter.removeListener('jobUpdate', handleJobUpdate);\n      }\n      if (typeof handleJobsClear === 'function') {\n        localJobEmitter.removeListener('jobsClear', handleJobsClear);\n      }\n      port.onmessage = this.handlePortMessage.bind(this);\n\n      handleJobAdd = (...args:Array<any>) => {\n        port.postMessage({ type: 'jobAdd', args });\n      };\n      handleJobDelete = (...args:Array<any>) => {\n        port.postMessage({ type: 'jobDelete', args });\n      };\n      handleJobUpdate = (...args:Array<any>) => {\n        port.postMessage({ type: 'jobUpdate', args });\n      };\n      handleJobsClear = (...args:Array<any>) => {\n        port.postMessage({ type: 'jobsClear', args });\n      };\n      localJobEmitter.addListener('jobAdd', handleJobAdd);\n      localJobEmitter.addListener('jobDelete', handleJobDelete);\n      localJobEmitter.addListener('jobUpdate', handleJobUpdate);\n      localJobEmitter.addListener('jobsClear', handleJobsClear);\n      const emitCallback = (t:string, args:Array<any>) => {\n        port.postMessage({ type: t, args });\n      };\n      activeEmitCallback = emitCallback;\n      this.emitCallbacks.push(emitCallback);\n      this.port = port;\n      port.postMessage({ type: 'BATTERY_QUEUE_WORKER_CONFIRMATION' });\n      this.logger.info('Linked to worker interface');\n    });\n    self.addEventListener('messageerror', (event:MessageEvent) => {\n      this.logger.error('Service worker interface message error');\n      this.logger.errorObject(event);\n    });\n  }\n}\n\n"],"file":"queue.js"}