{"version":3,"sources":["../../src/queue.js"],"names":["PRIORITY_OFFSET","Math","floor","Number","MAX_SAFE_INTEGER","BatteryQueue","options","dequeueQueue","PQueue","concurrency","handlerMap","Map","cleanupMap","retryJobDelayMap","retryCleanupDelayMap","queueMap","jobIds","Set","abortControllerMap","isClearing","emitCallbacks","logger","on","error","errorStack","type","args","emitCallback","retryJobDelayFunction","has","Error","set","delete","attempt","get","result","emit","retryCleanupDelayFunction","handler","cleanup","onIdle","start","queueId","priority","func","queue","add","newQueue","autoStart","Promise","resolve","timeout","setTimeout","removeListener","handleClearing","handleActive","clearTimeout","addListener","pending","size","info","jobs","queueAbortControllerMap","values","abortController","abort","startJobs","bind","newJobs","Array","isArray","keys","queueIds","id","status","startAfter","pause","JOB_PENDING_STATUS","startJob","JOB_ERROR_STATUS","startErrorHandler","JOB_CLEANUP_STATUS","startCleanup","maxDuration","onIdlePromise","Date","now","warn","interval","setInterval","clearInterval","jobsInterval","length","dequeue","newAbortController","AbortController","cleanupJob","data","undefined","delay","toLocaleString","path","name","getRetryCleanupDelay","retryCleanupDelay","newStartAfter","runCleanup","run","addToQueue","signal","duration","reject","removeEventListener","handleAbort","AbortError","addEventListener","updateCleanupData","getAbortController","delayJobStart","aborted","removeAbortController","abortQueue","getRetryJobDelay","retryDelay","event","ExtendableMessageEvent","ports","port","MessagePort","postMessage","onmessage","handlePortMessage","push","t","MessageEvent","warnObject","value","clear","errorObject","errorObjectParser","serializeError","self","handleInitializationMessage","EventEmitter"],"mappings":"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","sourcesContent":["// @flow\n\nimport PQueue from 'p-queue';\nimport errorObjectParser from 'serialize-error';\nimport EventEmitter from 'events';\nimport type { Logger } from './logger';\nimport makeLogger from './logger';\nimport type { Job } from './database';\nimport {\n  clearDatabase,\n  dequeueFromDatabase,\n  dequeueFromDatabaseNotIn,\n  incrementJobAttemptInDatabase,\n  incrementCleanupAttemptInDatabase,\n  markJobCompleteInDatabase,\n  markJobPendingInDatabase,\n  markJobErrorInDatabase,\n  markJobCleanupInDatabase,\n  markJobAbortedInDatabase,\n  markJobStartAfterInDatabase,\n  markCleanupStartAfterInDatabase,\n  updateCleanupValuesInDatabase,\n  getCleanupFromDatabase,\n  removePathFromCleanupDataInDatabase,\n  markQueueForCleanupInDatabase,\n  removeCleanupFromDatabase,\n  JOB_PENDING_STATUS,\n  JOB_ERROR_STATUS,\n  JOB_CLEANUP_STATUS,\n} from './database';\nimport { AbortError } from './errors';\n\nconst PRIORITY_OFFSET = Math.floor(Number.MAX_SAFE_INTEGER / 2);\n\ntype HandlerFunction = (Array<any>, AbortSignal, (Object) => Promise<void>) => Promise<void>;\ntype CleanupFunction = (Object | void, Array<any>, Array<string> => Promise<void>) => Promise<void>;\ntype RetryDelayFunction = (number, Error) => number | false | Promise<number | false>;\ntype EmitCallback = (string, Array<any>) => void;\n\ntype Options = {\n  logger?: Logger\n};\n\nexport default class BatteryQueue extends EventEmitter {\n  declare logger: Logger;\n  declare dequeueQueue: PQueue;\n  declare handlerMap: Map<string, HandlerFunction>;\n  declare retryJobDelayMap: Map<string, RetryDelayFunction>;\n  declare retryCleanupDelayMap: Map<string, RetryDelayFunction>;\n  declare cleanupMap: Map<string, CleanupFunction>;\n  declare queueMap: Map<string, PQueue>;\n  declare abortControllerMap: Map<string, Map<number, AbortController>>;\n  declare isClearing: boolean;\n  declare onIdlePromise: Promise<void> | void;\n  declare jobIds: Set<number>;\n  declare emitCallbacks: Array<EmitCallback>;\n  declare port: MessagePort;\n\n  constructor(options?: Options = {}) {\n    super();\n    this.dequeueQueue = new PQueue({ concurrency: 1 });\n    this.handlerMap = new Map();\n    this.cleanupMap = new Map();\n    this.retryJobDelayMap = new Map();\n    this.retryCleanupDelayMap = new Map();\n    this.queueMap = new Map();\n    this.jobIds = new Set();\n    this.abortControllerMap = new Map();\n    this.isClearing = false;\n    this.emitCallbacks = [];\n    this.logger = options.logger || makeLogger('Battery Queue');\n    this.on('error', (error) => {\n      this.logger.errorStack(error);\n    });\n  }\n\n  emit(type:string, ...args:Array<any>) {\n    for (const emitCallback of this.emitCallbacks) {\n      emitCallback(type, args);\n    }\n    return super.emit(type, ...args);\n  }\n\n  setRetryJobDelay(type:string, retryJobDelayFunction:RetryDelayFunction) {\n    if (this.retryJobDelayMap.has(type)) {\n      throw new Error(`Retry job delay handler for type \"${type}\" already exists`);\n    }\n    this.retryJobDelayMap.set(type, retryJobDelayFunction);\n  }\n\n  removeRetryJobDelay(type:string) {\n    if (!this.retryJobDelayMap.has(type)) {\n      throw new Error(`Retry job delay handler for type \"${type}\" does not exist`);\n    }\n    this.retryJobDelayMap.delete(type);\n  }\n\n  async getRetryJobDelay(type:string, attempt: number, error:Error) {\n    const retryJobDelayFunction = this.retryJobDelayMap.get(type);\n    if (typeof retryJobDelayFunction !== 'function') {\n      return false;\n    }\n    let result = false;\n    try {\n      result = await retryJobDelayFunction(attempt, error);\n    } catch (retryDelayError) {\n      this.logger.error(`Error in retry job delay handler for type \"${type}\" on attempt ${attempt}`);\n      this.emit('error', retryDelayError);\n      return false;\n    }\n    if (typeof result !== 'number' && result !== false) {\n      throw new Error(`Retry job delay function for type \"${type}\" returned invalid response, should be a number (milliseconds) or false`);\n    }\n    return result;\n  }\n\n  setRetryCleanupDelay(type:string, retryCleanupDelayFunction:RetryDelayFunction) {\n    if (this.retryCleanupDelayMap.has(type)) {\n      throw new Error(`Retry cleanup delay handler for type \"${type}\" already exists`);\n    }\n    this.retryCleanupDelayMap.set(type, retryCleanupDelayFunction);\n  }\n\n  removeRetryCleanupDelay(type:string) {\n    if (!this.retryCleanupDelayMap.has(type)) {\n      throw new Error(`Retry cleanup delay handler for type \"${type}\" does not exist`);\n    }\n    this.retryCleanupDelayMap.delete(type);\n  }\n\n  async getRetryCleanupDelay(type:string, attempt: number, error:Error) {\n    const retryCleanupDelayFunction = this.retryCleanupDelayMap.get(type);\n    if (typeof retryCleanupDelayFunction !== 'function') {\n      return false;\n    }\n    let result = false;\n    try {\n      result = await retryCleanupDelayFunction(attempt, error);\n    } catch (retryDelayError) {\n      this.logger.error(`Error in retry cleanup delay handler for type \"${type}\" on attempt ${attempt}`);\n      this.emit('error', retryDelayError);\n      return false;\n    }\n    if (typeof result !== 'number' && result !== false) {\n      throw new Error(`Retry cleanup delay function for type \"${type}\" returned invalid response, should be a number (milliseconds) or false`);\n    }\n    return result;\n  }\n\n  setHandler(type:string, handler: HandlerFunction) {\n    if (this.handlerMap.has(type)) {\n      throw new Error(`Handler for type \"${type}\" already exists`);\n    }\n    this.handlerMap.set(type, handler);\n  }\n\n  removeHandler(type:string) {\n    if (!this.handlerMap.has(type)) {\n      throw new Error(`Handler for type \"${type}\" does not exist`);\n    }\n    this.handlerMap.delete(type);\n  }\n\n  setCleanup(type:string, cleanup: CleanupFunction) {\n    if (this.cleanupMap.has(type)) {\n      throw new Error(`Cleanup for type \"${type}\" already exists`);\n    }\n    this.cleanupMap.set(type, cleanup);\n  }\n\n  removeCleanup(type:string) {\n    if (!this.handlerMap.has(type)) {\n      throw new Error(`Cleanup for type \"${type}\" does not exist`);\n    }\n    this.cleanupMap.delete(type);\n  }\n\n  async clear() {\n    this.isClearing = true;\n    await this.onIdle();\n    this.emit('clearing');\n    await clearDatabase();\n    this.dequeueQueue.start();\n    this.isClearing = false;\n  }\n\n  addToQueue(queueId:string, priority: number, func: () => Promise<void>) {\n    const queue = this.queueMap.get(queueId);\n    if (typeof queue !== 'undefined') {\n      queue.add(func, { priority });\n      return;\n    }\n    const newQueue = new PQueue({ concurrency: 1, autoStart: false });\n    this.queueMap.set(queueId, newQueue);\n    newQueue.add(func, { priority });\n    newQueue.on('idle', async () => {\n      if (!this.isClearing) {\n        await new Promise((resolve) => {\n          const timeout = setTimeout(() => {\n            this.removeListener('clearing', handleClearing);\n            newQueue.removeListener('active', handleActive);\n            resolve();\n          }, 5000);\n          const handleClearing = () => {\n            clearTimeout(timeout);\n            this.removeListener('clearing', handleClearing);\n            newQueue.removeListener('active', handleActive);\n            resolve();\n          };\n          const handleActive = () => {\n            clearTimeout(timeout);\n            this.removeListener('clearing', handleClearing);\n            newQueue.removeListener('active', handleActive);\n            resolve();\n          };\n          this.addListener('clearing', handleClearing);\n          newQueue.addListener('active', handleActive);\n        });\n      }\n      if (newQueue.pending > 0 || newQueue.size > 0) {\n        return;\n      }\n      this.queueMap.delete(queueId);\n    });\n  }\n\n  async abortQueue(queueId: string) {\n    this.logger.info(`Aborting queue ${queueId}`);\n    // Changes:\n    // * JOB_ERROR_STATUS -> JOB_CLEANUP_STATUS\n    // * JOB_COMPLETE_STATUS -> JOB_CLEANUP_STATUS\n    // * JOB_PENDING_STATUS -> JOB_ABORTED_STATUS\n    const jobs = await markQueueForCleanupInDatabase(queueId);\n    // Abort active jobs\n    const queueAbortControllerMap = this.abortControllerMap.get(queueId);\n    if (typeof queueAbortControllerMap !== 'undefined') {\n      for (const abortController of queueAbortControllerMap.values()) {\n        abortController.abort();\n      }\n    }\n    this.abortControllerMap.delete(queueId);\n    await this.startJobs(jobs);\n  }\n\n  dequeue():void | Promise<void> {\n    if (this.dequeueQueue.size === 0) {\n      // Add a subsequent dequeue\n      this.dequeueQueue.add(this.startJobs.bind(this));\n    }\n    return this.dequeueQueue.onIdle();\n  }\n\n  async startJobs(newJobs?:Array<Job>) { // eslint-disable-line consistent-return\n    const jobs = Array.isArray(newJobs) ? newJobs : await dequeueFromDatabaseNotIn([...this.jobIds.keys()]);\n    const queueIds = new Set();\n    for (const { id, queueId, args, type, status, attempt, startAfter } of jobs) {\n      if (this.jobIds.has(id)) {\n        continue;\n      }\n      // Pause queues before adding items into them to avoid starting things out of priority\n      if (!queueIds.has(queueId)) {\n        const queue = this.queueMap.get(queueId);\n        if (typeof queue !== 'undefined') {\n          queue.pause();\n        }\n        queueIds.add(queueId);\n      }\n      if (status === JOB_PENDING_STATUS) {\n        this.startJob(id, queueId, args, type, attempt + 1, startAfter);\n      } else if (status === JOB_ERROR_STATUS) {\n        this.startErrorHandler(id, queueId, args, type, attempt, startAfter);\n      } else if (status === JOB_CLEANUP_STATUS) {\n        this.startCleanup(id, queueId, args, type);\n      } else {\n        throw new Error(`Unknown job status ${status} in job ${id} of queue ${queueId}`);\n      }\n    }\n    for (const queueId of queueIds) {\n      const queue = this.queueMap.get(queueId);\n      if (typeof queue !== 'undefined') {\n        queue.start();\n      } else {\n        this.logger.error(`Unable to start queue ${queueId} after dequeue; queue does not exist`);\n      }\n    }\n  }\n\n  async onIdle(maxDuration?: number = 5000) {\n    if (typeof this.onIdlePromise === 'undefined') {\n      this.onIdlePromise = (async () => {\n        const timeout = Date.now() + maxDuration;\n        while (true) { // eslint-disable-line no-constant-condition\n          if (Date.now() > timeout) {\n            this.logger.warn(`Idle timeout after ${maxDuration}ms`);\n            break;\n          }\n          await this.dequeueQueue.onIdle();\n          for (const [queueId, queue] of this.queueMap) {\n            const interval = setInterval(() => {\n              this.logger.info(`Waiting on queue ${queueId}`);\n            }, 250);\n            await queue.onIdle();\n            clearInterval(interval);\n          }\n          const jobsInterval = setInterval(() => {\n            this.logger.info('Waiting on jobs');\n          }, 250);\n          const jobs = await dequeueFromDatabase();\n          clearInterval(jobsInterval);\n          if (jobs.length > 0) {\n            const interval = setInterval(() => {\n              this.logger.info('Waiting on dequeue');\n            }, 250);\n            await this.dequeue();\n            clearInterval(interval);\n            continue;\n          }\n          break;\n        }\n        delete this.onIdlePromise;\n        this.emit('idle');\n      })();\n    }\n    await this.onIdlePromise;\n  }\n\n  getAbortController(id:number, queueId:string) {\n    let queueAbortControllerMap = this.abortControllerMap.get(queueId);\n    if (typeof queueAbortControllerMap === 'undefined') {\n      queueAbortControllerMap = new Map();\n      this.abortControllerMap.set(queueId, queueAbortControllerMap);\n    }\n    const abortController = queueAbortControllerMap.get(id);\n    if (typeof abortController !== 'undefined') {\n      return abortController;\n    }\n    const newAbortController = new AbortController();\n    queueAbortControllerMap.set(id, newAbortController);\n    return newAbortController;\n  }\n\n  removeAbortController(id:number, queueId:string) {\n    const queueAbortControllerMap = this.abortControllerMap.get(queueId);\n    if (typeof queueAbortControllerMap === 'undefined') {\n      this.logger.warn(`Abort controller map for ${id} in queue ${queueId} does not exist`);\n      return;\n    }\n    const abortController = queueAbortControllerMap.get(id);\n    if (typeof abortController === 'undefined') {\n      this.logger.warn(`Abort controller for ${id} in queue ${queueId} does not exist`);\n      return;\n    }\n    queueAbortControllerMap.delete(id);\n  }\n\n  async runCleanup(id:number, queueId:string, args:Array<any>, type:string) {\n    this.emit('cleanupStart', { id });\n    const cleanup = this.cleanupMap.get(type);\n    if (typeof cleanup !== 'function') {\n      this.logger.warn(`No cleanup for job type ${type}`);\n      await removeCleanupFromDatabase(id);\n      this.jobIds.delete(id);\n      this.emit('cleanup', { id });\n      return;\n    }\n    const cleanupJob = await getCleanupFromDatabase(id);\n    const { data, startAfter } = typeof cleanupJob === 'undefined' ? { data: undefined, startAfter: 0 } : cleanupJob;\n    const delay = startAfter - Date.now();\n    if (delay > 0) {\n      this.logger.warn(`Delaying retry of ${type} job #${id} cleanup in queue ${queueId} by ${delay}ms to ${new Date(startAfter).toLocaleString()}`);\n      await new Promise((resolve) => setTimeout(resolve, delay));\n    }\n    try {\n      await cleanup(data, args, (path:Array<string>) => removePathFromCleanupDataInDatabase(id, path));\n    } catch (error) {\n      const attempt = await incrementCleanupAttemptInDatabase(id, queueId);\n      if (error.name === 'FatalCleanupError') {\n        this.logger.error(`Fatal error in ${type} job #${id} cleanup in queue ${queueId} attempt ${attempt}`);\n        this.emit('error', error);\n        await removeCleanupFromDatabase(id);\n        this.jobIds.delete(id);\n        this.emit('fatalCleanupError', { id, queueId });\n        return;\n      }\n      const retryCleanupDelay = await this.getRetryCleanupDelay(type, attempt, error);\n      if (retryCleanupDelay === false) {\n        this.logger.error(`Error in ${type} job #${id} cleanup in queue ${queueId} attempt ${attempt} with no additional attempts requested`);\n        this.emit('error', error);\n        await removeCleanupFromDatabase(id);\n        this.jobIds.delete(id);\n        this.emit('fatalCleanupError', { id, queueId });\n        return;\n      }\n      this.logger.error(`Error in ${type} job #${id} cleanup in queue ${queueId} attempt ${attempt}, retrying ${retryCleanupDelay > 0 ? `in ${retryCleanupDelay}ms'}` : 'immediately'}`);\n      this.emit('error', error);\n      if (retryCleanupDelay > 0) {\n        this.emit('retryCleanupDelay', { id, queueId, retryCleanupDelay });\n        const newStartAfter = Date.now() + retryCleanupDelay;\n        await markCleanupStartAfterInDatabase(id, newStartAfter);\n      }\n      await this.runCleanup(id, queueId, args, type);\n      return;\n    }\n    await removeCleanupFromDatabase(id);\n    this.jobIds.delete(id);\n    this.emit('cleanup', { id });\n  }\n\n  startCleanup(id:number, queueId:string, args:Array<any>, type:string) {\n    this.logger.info(`Adding ${type} cleanup job #${id} to queue ${queueId}`);\n    this.jobIds.add(id);\n    const priority = PRIORITY_OFFSET + id;\n    const run = async () => {\n      this.logger.info(`Starting ${type} cleanup #${id} in queue ${queueId}`);\n      await this.runCleanup(id, queueId, args, type);\n      await markJobAbortedInDatabase(id);\n    };\n    this.addToQueue(queueId, priority, run);\n  }\n\n  startErrorHandler(id:number, queueId:string, args:Array<any>, type:string, attempt: number, startAfter: number) {\n    this.logger.info(`Adding ${type} error handler job #${id} to queue ${queueId}`);\n    this.jobIds.add(id);\n    const priority = PRIORITY_OFFSET + id;\n    const run = async () => {\n      this.logger.info(`Starting ${type} error handler #${id} in queue ${queueId}`);\n      await this.runCleanup(id, queueId, args, type);\n      await markJobPendingInDatabase(id);\n      this.logger.info(`Retrying ${type} job #${id} in queue ${queueId}`);\n      this.emit('retry', { id });\n      this.startJob(id, queueId, args, type, attempt + 1, startAfter);\n    };\n    this.addToQueue(queueId, priority, run);\n  }\n\n  async delayJobStart(id:number, queueId:string, type:string, signal: AbortSignal, startAfter: number) {\n    const duration = startAfter - Date.now();\n    if (duration > 0) {\n      this.logger.info(`Delaying start of ${type} job #${id} in queue ${queueId} by ${duration}ms`);\n      await new Promise((resolve, reject) => {\n        const timeout = setTimeout(() => {\n          signal.removeEventListener('abort', handleAbort);\n          resolve();\n        }, duration);\n        const handleAbort = () => {\n          clearTimeout(timeout);\n          signal.removeEventListener('abort', handleAbort);\n          reject(new AbortError('Aborted'));\n        };\n        signal.addEventListener('abort', handleAbort);\n      });\n    }\n  }\n\n  startJob(id:number, queueId:string, args:Array<any>, type:string, attempt:number, startAfter: number) {\n    this.logger.info(`Adding ${type} job #${id} to queue ${queueId}`);\n    this.jobIds.add(id);\n    const priority = PRIORITY_OFFSET - id;\n    const updateCleanupData = (data:Object) => updateCleanupValuesInDatabase(id, queueId, data);\n    const run = async () => {\n      this.logger.info(`Starting ${type} job #${id} in queue ${queueId} attempt ${attempt}`);\n      const handler = this.handlerMap.get(type);\n      if (typeof handler !== 'function') {\n        this.logger.warn(`No handler for job type ${type}`);\n        await markJobCompleteInDatabase(id);\n        this.emit('complete', { id });\n        this.jobIds.delete(id);\n        return;\n      }\n      const abortController = this.getAbortController(id, queueId);\n      // Mark as error in database so the job is cleaned up and retried if execution\n      // stops before job completion or error\n      await markJobErrorInDatabase(id);\n      try {\n        await this.delayJobStart(id, queueId, type, abortController.signal, startAfter);\n        await handler(args, abortController.signal, updateCleanupData);\n        if (abortController.signal.aborted) {\n          throw new AbortError('Aborted');\n        }\n        this.removeAbortController(id, queueId);\n      } catch (error) {\n        this.removeAbortController(id, queueId);\n        await incrementJobAttemptInDatabase(id);\n        if (error.name === 'FatalError') {\n          this.logger.error(`Fatal error in ${type} job #${id} in queue ${queueId} attempt ${attempt}`);\n          this.emit('error', error);\n          this.emit('fatalError', { queueId });\n          this.jobIds.delete(id);\n          await this.abortQueue(queueId);\n          return;\n        }\n        if (error.name === 'AbortError') {\n          this.logger.error(`Abort error in ${type} job #${id} in queue ${queueId} attempt ${attempt}`);\n          this.emit('error', error);\n          await markJobCleanupInDatabase(id);\n          this.jobIds.delete(id);\n          this.startCleanup(id, queueId, args, type);\n          return;\n        }\n        const retryDelay = await this.getRetryJobDelay(type, attempt, error);\n        if (retryDelay === false) {\n          this.logger.error(`Error in ${type} job #${id} in queue ${queueId} attempt ${attempt} with no additional attempts requested`);\n          this.emit('error', error);\n          this.emit('fatalError', { queueId });\n          this.jobIds.delete(id);\n          await this.abortQueue(queueId);\n          return;\n        }\n        this.logger.error(`Error in ${type} job #${id} in queue ${queueId} attempt ${attempt}, retrying ${retryDelay > 0 ? `in ${retryDelay}ms'}` : 'immediately'}`);\n        this.emit('error', error);\n        if (retryDelay > 0) {\n          this.emit('retryDelay', { id, queueId, retryDelay });\n          const newStartAfter = Date.now() + retryDelay;\n          await markJobStartAfterInDatabase(id, newStartAfter);\n          this.jobIds.delete(id);\n          this.startErrorHandler(id, queueId, args, type, attempt, newStartAfter);\n        } else {\n          this.jobIds.delete(id);\n          this.startErrorHandler(id, queueId, args, type, attempt, startAfter);\n        }\n        return;\n      }\n      await markJobCompleteInDatabase(id);\n      this.emit('complete', { id });\n      this.jobIds.delete(id);\n    };\n    this.addToQueue(queueId, priority, run);\n    this.emit('dequeue', { id });\n  }\n\n  handleInitializationMessage(event:ExtendableMessageEvent) {\n    if (!(event instanceof ExtendableMessageEvent)) {\n      return;\n    }\n    const { data } = event;\n    if (!data || typeof data !== 'object') {\n      return;\n    }\n    const { type } = data;\n    if (type !== 'BATTERY_QUEUE_WORKER_INITIALIZATION') {\n      return;\n    }\n    if (!Array.isArray(event.ports)) {\n      return;\n    }\n    const port = event.ports[0];\n    if (!(port instanceof MessagePort)) {\n      return;\n    }\n    port.postMessage({ type: 'BATTERY_QUEUE_WORKER_CONFIRMATION' });\n    this.logger.info('Linked to interface');\n    port.onmessage = this.handlePortMessage.bind(this);\n    this.emitCallbacks.push((t:string, args:Array<any>) => {\n      port.postMessage({ type: t, args });\n    });\n    this.port = port;\n  }\n\n  async handlePortMessage(event:MessageEvent) {\n    if (!(event instanceof MessageEvent)) {\n      return;\n    }\n    const { data } = event;\n    if (!data || typeof data !== 'object') {\n      this.logger.warn('Invalid message data');\n      this.logger.warnObject(event);\n      return;\n    }\n    const { type, value } = data;\n    if (typeof type !== 'string') {\n      this.logger.warn('Unknown message type');\n      this.logger.warnObject(event);\n      return;\n    }\n    if (value === null || typeof value !== 'object') {\n      throw new Error('Message payload should be an object');\n    }\n    const { id } = value;\n    if (typeof id !== 'number') {\n      throw new Error('Message payload should include property id with type number');\n    }\n    switch (type) {\n      case 'clear':\n        try {\n          await this.clear();\n          this.emit('clearComplete', { id });\n        } catch (error) {\n          this.emit('clearError', { errorObject: errorObjectParser.serializeError(error), id });\n          this.logger.error('Unable to handle clear message');\n          this.emit('error', error);\n        }\n        break;\n      case 'abortQueue':\n        try {\n          const { queueId } = value;\n          if (typeof queueId !== 'string') {\n            throw new Error('Message abort queue payload should include property queueId with type string');\n          }\n          await this.abortQueue(queueId);\n          this.emit('abortQueueComplete', { id });\n        } catch (error) {\n          this.emit('abortQueueError', { errorObject: errorObjectParser.serializeError(error), id });\n          this.logger.error('Unable to handle abort queue message');\n          this.emit('error', error);\n        }\n        break;\n      case 'dequeue':\n        try {\n          await this.dequeue();\n          this.emit('dequeueComplete', { id });\n        } catch (error) {\n          this.emit('dequeueError', { errorObject: errorObjectParser.serializeError(error), id });\n          this.logger.error('Unable to handle dequeue message');\n          this.emit('error', error);\n        }\n        break;\n      case 'idle':\n        try {\n          const { maxDuration, start } = value;\n          if (typeof maxDuration !== 'number') {\n            throw new Error('Message idle payload should include property maxDuration with type number');\n          }\n          if (typeof start !== 'number') {\n            throw new Error('Message idle payload should include property start with type number');\n          }\n          await this.onIdle(maxDuration - (Date.now() - start));\n          this.emit('idleComplete', { id });\n        } catch (error) {\n          this.emit('idleError', { errorObject: errorObjectParser.serializeError(error), id });\n          this.logger.error('Unable to handle idle message');\n          this.emit('error', error);\n        }\n        break;\n      default:\n        this.logger.warn(`Unknown worker interface message type ${type}`);\n    }\n  }\n\n  listenForServiceWorkerInterface() {\n    self.addEventListener('message', this.handleInitializationMessage.bind(this));\n  }\n}\n\n"],"file":"queue.js"}