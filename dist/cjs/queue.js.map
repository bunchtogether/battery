{"version":3,"sources":["../../src/queue.js"],"names":["PRIORITY_OFFSET","Math","floor","Number","MAX_SAFE_INTEGER","BatteryQueue","options","dequeueQueue","PQueue","concurrency","handlerMap","Map","cleanupMap","retryDelayMap","queueMap","jobIds","Set","abortControllerMap","isClearing","emitCallbacks","logger","type","args","emitCallback","delayOrFunction","set","error","delete","handler","handlers","get","push","filter","f","length","cleanup","cleanups","onIdle","emit","start","queueId","priority","func","queue","add","newQueue","autoStart","on","Promise","resolve","timeout","setTimeout","removeListener","handleClearing","clearTimeout","addListener","pending","size","info","queueAbortControllerMap","values","abortController","abort","_dequeue","bind","jobs","queueIds","id","status","attempt","maxAttempts","startAfter","has","pause","JOB_PENDING_STATUS","startJob","JOB_ERROR_STATUS","startErrorHandler","JOB_CLEANUP_STATUS","startCleanup","Error","maxDuration","onIdlePromise","Date","now","warn","interval","setInterval","clearInterval","jobsInterval","dequeue","newAbortController","AbortController","removePathFromCleanupData","path","hasFatalError","hasError","delayRetryErrorMs","Array","isArray","cleanupJob","undefined","errorStack","data","delay","toLocaleString","name","newStartAfter","runCleanups","run","addToQueue","abortQueue","signal","duration","reject","removeEventListener","handleAbort","AbortError","addEventListener","getAbortController","updateCleanupData","maxCleanupAttempts","delayJobStart","attemptsRemaining","aborted","removeAbortController","job","JOB_COMPLETE_STATUS","JOB_ABORTED_STATUS","retryDelayFunction","delayRetryMs","event","ExtendableMessageEvent","ports","port","MessagePort","postMessage","onmessage","handlePortMessage","t","MessageEvent","warnObject","value","clear","errorObject","errorObjectParser","serializeError","self","handleInitializationMessage","EventEmitter"],"mappings":"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","sourcesContent":["// @flow\n\nimport PQueue from 'p-queue';\nimport errorObjectParser from 'serialize-error';\nimport EventEmitter from 'events';\nimport type { Logger } from './logger';\nimport makeLogger from './logger';\nimport {\n  clearDatabase,\n  dequeueFromDatabase,\n  incrementJobAttemptInDatabase,\n  incrementCleanupAttemptInDatabase,\n  markJobCompleteInDatabase,\n  markJobPendingInDatabase,\n  markJobErrorInDatabase,\n  markJobCleanupInDatabase,\n  markJobAbortedInDatabase,\n  markJobStartAfterInDatabase,\n  markCleanupStartAfterInDatabase,\n  updateCleanupInDatabase,\n  getCleanupFromDatabase,\n  getJobFromDatabase,\n  removePathFromCleanupDataInDatabase,\n  markQueueForCleanupInDatabase,\n  removeCleanupFromDatabase,\n  JOB_PENDING_STATUS,\n  JOB_ABORTED_STATUS,\n  JOB_ERROR_STATUS,\n  JOB_CLEANUP_STATUS,\n  JOB_COMPLETE_STATUS,\n} from './database';\nimport { AbortError } from './errors';\n\nconst PRIORITY_OFFSET = Math.floor(Number.MAX_SAFE_INTEGER / 2);\n\ntype HandlerFunction = (Array<any>, AbortSignal, (Object, number) => Promise<void>) => Promise<void>;\ntype CleanupFunction = (Object | void, Array<any>, Array<string> => Promise<void>) => Promise<void>;\ntype RetryDelayFunction = (number) => number;\ntype EmitCallback = (string, Array<any>) => void;\n\ntype Options = {\n  logger?: Logger\n};\n\nexport default class BatteryQueue extends EventEmitter {\n  declare logger: Logger;\n  declare dequeueQueue: PQueue;\n  declare handlerMap: Map<string, Array<HandlerFunction>>;\n  declare retryDelayMap: Map<string, (number) => number>;\n  declare cleanupMap: Map<string, Array<CleanupFunction>>;\n  declare queueMap: Map<string, PQueue>;\n  declare abortControllerMap: Map<string, Map<number, AbortController>>;\n  declare isClearing: boolean;\n  declare onIdlePromise: Promise<void> | void;\n  declare jobIds: Set<number>;\n  declare emitCallbacks: Array<EmitCallback>;\n  declare port: MessagePort;\n\n  constructor(options?: Options = {}) {\n    super();\n    this.dequeueQueue = new PQueue({ concurrency: 1 });\n    this.handlerMap = new Map();\n    this.cleanupMap = new Map();\n    this.retryDelayMap = new Map();\n    this.queueMap = new Map();\n    this.jobIds = new Set();\n    this.abortControllerMap = new Map();\n    this.isClearing = false;\n    this.emitCallbacks = [];\n    this.logger = options.logger || makeLogger('Battery Queue');\n  }\n\n  emit(type:string, ...args:Array<any>) {\n    for (const emitCallback of this.emitCallbacks) {\n      emitCallback(type, args);\n    }\n    return super.emit(type, ...args);\n  }\n\n  setRetryDelay(type:string, delayOrFunction:number | RetryDelayFunction) {\n    if (typeof delayOrFunction === 'number') {\n      this.retryDelayMap.set(type, () => delayOrFunction);\n    } else if (typeof delayOrFunction === 'function') {\n      this.retryDelayMap.set(type, delayOrFunction);\n    } else {\n      this.logger.error(`Unable to set retry delay for ${type}, unknown handler type ${typeof delayOrFunction}`);\n    }\n  }\n\n  removeRetryDelay(type:string) {\n    this.retryDelayMap.delete(type);\n  }\n\n  addHandler(type:string, handler: HandlerFunction) {\n    const handlers = this.handlerMap.get(type) || [];\n    handlers.push(handler);\n    this.handlerMap.set(type, handlers);\n  }\n\n  removeHandler(type:string, handler: HandlerFunction) {\n    const handlers = (this.handlerMap.get(type) || []).filter((f) => f !== handler);\n    if (handlers.length > 0) {\n      this.handlerMap.set(type, handlers);\n    } else {\n      this.handlerMap.delete(type);\n    }\n  }\n\n  addCleanup(type:string, cleanup: CleanupFunction) {\n    const cleanups = this.cleanupMap.get(type) || [];\n    cleanups.push(cleanup);\n    this.cleanupMap.set(type, cleanups);\n  }\n\n  removeCleanup(type:string, cleanup: CleanupFunction) {\n    const cleanups = (this.cleanupMap.get(type) || []).filter((f) => f !== cleanup);\n    if (cleanups.length > 0) {\n      this.cleanupMap.set(type, cleanups);\n    } else {\n      this.cleanupMap.delete(type);\n    }\n  }\n\n  async clear() {\n    this.isClearing = true;\n    await this.onIdle();\n    this.emit('clearing');\n    await clearDatabase();\n    this.dequeueQueue.start();\n    this.isClearing = false;\n  }\n\n  addToQueue(queueId:string, priority: number, func: () => Promise<void>) {\n    const queue = this.queueMap.get(queueId);\n    if (typeof queue !== 'undefined') {\n      queue.add(func, { priority });\n      return;\n    }\n    const newQueue = new PQueue({ concurrency: 1, autoStart: false });\n    this.queueMap.set(queueId, newQueue);\n    newQueue.add(func, { priority });\n    newQueue.on('idle', async () => {\n      if (!this.isClearing) {\n        await new Promise((resolve) => {\n          const timeout = setTimeout(() => {\n            this.removeListener('clearing', handleClearing);\n            resolve();\n          }, 5000);\n          const handleClearing = () => {\n            clearTimeout(timeout);\n            this.removeListener('clearing', handleClearing);\n            resolve();\n          };\n          this.addListener('clearing', handleClearing);\n        });\n      }\n      if (newQueue.pending > 0 || newQueue.size > 0) {\n        return;\n      }\n      this.queueMap.delete(queueId);\n    });\n  }\n\n  async abortQueue(queueId: string) {\n    this.logger.info(`Aborting queue ${queueId}`);\n    // Changes:\n    // * JOB_ERROR_STATUS -> JOB_CLEANUP_STATUS\n    // * JOB_COMPLETE_STATUS -> JOB_CLEANUP_STATUS\n    // * JOB_PENDING_STATUS -> JOB_ABORTED_STATUS\n    await markQueueForCleanupInDatabase(queueId);\n    // Abort active jobs\n    const queueAbortControllerMap = this.abortControllerMap.get(queueId);\n    if (typeof queueAbortControllerMap !== 'undefined') {\n      for (const abortController of queueAbortControllerMap.values()) {\n        abortController.abort();\n      }\n    }\n    this.abortControllerMap.delete(queueId);\n  }\n\n  dequeue():void | Promise<void> {\n    if (this.dequeueQueue.size === 0) {\n      // Add a subsequent dequeue\n      this.dequeueQueue.add(this._dequeue.bind(this)); // eslint-disable-line no-underscore-dangle\n    }\n    return this.dequeueQueue.onIdle();\n  }\n\n  async _dequeue() { // eslint-disable-line consistent-return\n    const jobs = await dequeueFromDatabase();\n    const queueIds = new Set();\n    for (const { id, queueId, args, type, status, attempt, maxAttempts, startAfter } of jobs) {\n      if (this.jobIds.has(id)) {\n        continue;\n      }\n      // Pause queues before adding items into them to avoid starting things out of priority\n      if (!queueIds.has(queueId)) {\n        const queue = this.queueMap.get(queueId);\n        if (typeof queue !== 'undefined') {\n          queue.pause();\n        }\n        queueIds.add(queueId);\n      }\n      if (status === JOB_PENDING_STATUS) {\n        this.startJob(id, queueId, args, type, attempt, maxAttempts, startAfter);\n      } else if (status === JOB_ERROR_STATUS) {\n        this.startErrorHandler(id, queueId, args, type);\n      } else if (status === JOB_CLEANUP_STATUS) {\n        this.startCleanup(id, queueId, args, type);\n      } else {\n        throw new Error(`Unknown job status ${status} in job ${id} of queue ${queueId}`);\n      }\n    }\n    for (const queueId of queueIds) {\n      const queue = this.queueMap.get(queueId);\n      if (typeof queue !== 'undefined') {\n        queue.start();\n      } else {\n        this.logger.error(`Unable to start queue ${queueId} after dequeue; queue does not exist`);\n      }\n    }\n  }\n\n  async onIdle(maxDuration?: number = 5000) {\n    if (typeof this.onIdlePromise === 'undefined') {\n      this.onIdlePromise = (async () => {\n        const timeout = Date.now() + maxDuration;\n        while (true) { // eslint-disable-line no-constant-condition\n          if (Date.now() > timeout) {\n            this.logger.warn(`Idle timeout after ${maxDuration}ms`);\n            break;\n          }\n          await this.dequeueQueue.onIdle();\n          for (const [queueId, queue] of this.queueMap) {\n            const interval = setInterval(() => {\n              this.logger.info(`Waiting on queue ${queueId}`);\n            }, 250);\n            await queue.onIdle();\n            clearInterval(interval);\n          }\n          const jobsInterval = setInterval(() => {\n            this.logger.info('Waiting on jobs');\n          }, 250);\n          const jobs = await dequeueFromDatabase();\n          clearInterval(jobsInterval);\n          if (jobs.length > 0) {\n            const interval = setInterval(() => {\n              this.logger.info('Waiting on dequeue');\n            }, 250);\n            await this.dequeue();\n            clearInterval(interval);\n            continue;\n          }\n          break;\n        }\n        delete this.onIdlePromise;\n        this.emit('idle');\n      })();\n    }\n    await this.onIdlePromise;\n  }\n\n  getAbortController(id:number, queueId:string) {\n    let queueAbortControllerMap = this.abortControllerMap.get(queueId);\n    if (typeof queueAbortControllerMap === 'undefined') {\n      queueAbortControllerMap = new Map();\n      this.abortControllerMap.set(queueId, queueAbortControllerMap);\n    }\n    const abortController = queueAbortControllerMap.get(id);\n    if (typeof abortController !== 'undefined') {\n      return abortController;\n    }\n    const newAbortController = new AbortController();\n    queueAbortControllerMap.set(id, newAbortController);\n    return newAbortController;\n  }\n\n  removeAbortController(id:number, queueId:string) {\n    const queueAbortControllerMap = this.abortControllerMap.get(queueId);\n    if (typeof queueAbortControllerMap === 'undefined') {\n      this.logger.warn(`Abort controller map for ${id} in queue ${queueId} does not exist`);\n      return;\n    }\n    const abortController = queueAbortControllerMap.get(id);\n    if (typeof abortController === 'undefined') {\n      this.logger.warn(`Abort controller for ${id} in queue ${queueId} does not exist`);\n      return;\n    }\n    queueAbortControllerMap.delete(id);\n  }\n\n  async runCleanups(id:number, queueId:string, args:Array<any>, type:string) {\n    const removePathFromCleanupData = (path:Array<string>) => removePathFromCleanupDataInDatabase(id, path);\n    const cleanups = this.cleanupMap.get(type);\n    let hasFatalError = false;\n    let hasError = false;\n    let delayRetryErrorMs = 0;\n    if (Array.isArray(cleanups)) {\n      const cleanupJob = await getCleanupFromDatabase(id);\n      if (typeof cleanupJob === 'undefined') {\n        for (const cleanup of cleanups) {\n          try {\n            await cleanup(undefined, args, removePathFromCleanupData);\n          } catch (error) {\n            this.logger.error(`Error in ${type} job #${id} cleanup in queue ${queueId} attempt 1 with 0 attempts remaining, no cleanup data found`);\n            this.logger.errorStack(error);\n            hasFatalError = true;\n            hasError = true;\n          }\n        }\n      } else {\n        const { data, startAfter } = cleanupJob;\n        const delay = startAfter - Date.now();\n        if (delay > 0) {\n          this.logger.warn(`Delaying retry of ${type} job #${id} cleanup in queue ${queueId} by ${delay}ms to ${new Date(startAfter).toLocaleString()}`);\n          this.emit('delayCleanupRetry', { id, queueId, delay });\n          await new Promise((resolve) => setTimeout(resolve, delay));\n        }\n        for (const cleanup of cleanups) {\n          try {\n            await cleanup(data, args, removePathFromCleanupData);\n          } catch (error) {\n            const [attempt, maxAttempts] = await incrementCleanupAttemptInDatabase(id);\n            hasError = true;\n            if (error.name === 'FatalCleanupError') {\n              hasFatalError = true;\n              this.logger.error(`Fatal error in ${type} job #${id} cleanup in queue ${queueId} attempt ${attempt}`);\n              this.logger.errorStack(error);\n            } else if (attempt >= maxAttempts) {\n              hasFatalError = true;\n              this.logger.error(`Error in ${type} job #${id} cleanup in queue ${queueId} attempt ${attempt} with no attempts remaining`);\n              this.logger.errorStack(error);\n            } else {\n              this.logger.error(`Error in ${type} job #${id} cleanup in queue ${queueId} attempt ${attempt} with ${maxAttempts - attempt} ${maxAttempts - attempt === 1 ? 'attempt' : 'attempts'} remaining`);\n              this.logger.errorStack(error);\n              if (error.name === 'DelayRetryError') {\n                delayRetryErrorMs = error.delay || 0;\n              }\n            }\n          }\n        }\n      }\n    } else {\n      this.logger.warn(`No cleanup for job type ${type}`);\n    }\n    if (hasFatalError) {\n      await removeCleanupFromDatabase(id);\n      this.jobIds.delete(id);\n      this.emit('fatalCleanupError', { id, queueId });\n      return;\n    } else if (hasError) {\n      if (delayRetryErrorMs > 0) {\n        const newStartAfter = Date.now() + delayRetryErrorMs;\n        await markCleanupStartAfterInDatabase(id, newStartAfter);\n      }\n      this.emit('dequeueCleanup', { id });\n      await this.runCleanups(id, queueId, args, type);\n      return;\n    }\n    await removeCleanupFromDatabase(id);\n    this.jobIds.delete(id);\n    this.emit('cleanup', { id });\n  }\n\n  startCleanup(id:number, queueId:string, args:Array<any>, type:string) {\n    this.logger.info(`Adding ${type} cleanup job #${id} to queue ${queueId}`);\n    this.jobIds.add(id);\n    const priority = PRIORITY_OFFSET + id;\n    const run = async () => {\n      this.logger.info(`Starting ${type} cleanup job #${id} in queue ${queueId}`);\n      await this.runCleanups(id, queueId, args, type);\n      await markJobAbortedInDatabase(id);\n    };\n    this.addToQueue(queueId, priority, run);\n    this.emit('dequeueCleanup', { id });\n  }\n\n  startErrorHandler(id:number, queueId:string, args:Array<any>, type:string) {\n    this.logger.info(`Adding ${type} error handler job #${id} to queue ${queueId}`);\n    this.jobIds.add(id);\n    const priority = PRIORITY_OFFSET + id;\n    const run = async () => {\n      this.logger.info(`Starting ${type} error handler job #${id} in queue ${queueId}`);\n      await this.runCleanups(id, queueId, args, type);\n      const [attempt, maxAttempts] = await incrementJobAttemptInDatabase(id);\n      if (attempt >= maxAttempts) {\n        this.logger.warn(`Not retrying ${type} job #${id} in queue ${queueId} after ${maxAttempts} failed ${maxAttempts === 1 ? 'attempt' : 'attempts'}, cleaning up queue`);\n        await markJobAbortedInDatabase(id);\n        this.emit('fatalError', { queueId });\n        await this.abortQueue(queueId);\n      } else {\n        await markJobPendingInDatabase(id);\n        this.logger.info(`Retrying ${type} job #${id} in queue ${queueId}, ${maxAttempts - attempt} ${maxAttempts - attempt === 1 ? 'attempt' : 'attempts'} remaining`);\n        this.emit('retry', { id });\n      }\n      await this.dequeue();\n    };\n    this.addToQueue(queueId, priority, run);\n    this.emit('dequeueCleanup', { id });\n  }\n\n  async delayJobStart(id:number, queueId:string, type:string, signal: AbortSignal, startAfter: number) {\n    const duration = startAfter - Date.now();\n    if (duration > 0) {\n      this.logger.info(`Delaying start of ${type} job #${id} in queue ${queueId} by ${duration}ms`);\n      await new Promise((resolve, reject) => {\n        const timeout = setTimeout(() => {\n          signal.removeEventListener('abort', handleAbort);\n          resolve();\n        }, duration);\n        const handleAbort = () => {\n          clearTimeout(timeout);\n          signal.removeEventListener('abort', handleAbort);\n          reject(new AbortError('Aborted'));\n        };\n        signal.addEventListener('abort', handleAbort);\n      });\n    }\n  }\n\n  startJob(id:number, queueId:string, args:Array<any>, type:string, attempt:number, maxAttempts:number, startAfter: number) {\n    this.logger.info(`Adding ${type} job #${id} to queue ${queueId}`);\n    this.jobIds.add(id);\n    const priority = PRIORITY_OFFSET - id;\n    const abortController = this.getAbortController(id, queueId);\n    const updateCleanupData = (data:Object, maxCleanupAttempts:number) => updateCleanupInDatabase(id, queueId, data, maxCleanupAttempts);\n    const run = async () => {\n      await this.delayJobStart(id, queueId, type, abortController.signal, startAfter);\n      const attemptsRemaining = maxAttempts - attempt - 1;\n      if (attemptsRemaining > 0) {\n        this.logger.info(`Starting ${type} job #${id} in queue ${queueId} attempt ${attempt + 1} with ${attemptsRemaining} ${attemptsRemaining === 1 ? 'attempt' : 'attempts'} remaining`);\n      } else {\n        this.logger.info(`Starting ${type} job #${id} in queue ${queueId} attempt ${attempt + 1} with no attempts remaining`);\n      }\n      const handlers = this.handlerMap.get(type);\n      let hasError = false;\n      let hasFatalError = false;\n      let delayRetryErrorMs = 0;\n      if (Array.isArray(handlers)) {\n        for (const handler of handlers) {\n          try {\n            await handler(args, abortController.signal, updateCleanupData);\n            if (abortController.signal.aborted) {\n              throw new AbortError('Aborted');\n            }\n          } catch (error) {\n            if (attemptsRemaining > 0) {\n              this.logger.error(`Error in ${type} job #${id} in queue ${queueId} attempt ${attempt + 1} with ${attemptsRemaining} ${attemptsRemaining === 1 ? 'attempt' : 'attempts'} remaining`);\n            } else {\n              this.logger.error(`Error in ${type} job #${id} in queue ${queueId} attempt ${attempt + 1} with no attempts remaining`);\n            }\n            this.logger.errorStack(error);\n            hasError = true;\n            if (error.name === 'FatalQueueError') {\n              hasFatalError = true;\n            }\n            if (error.name === 'DelayRetryError') {\n              delayRetryErrorMs = error.delay || 0;\n            }\n            break;\n          }\n        }\n      } else {\n        this.logger.warn(`No handler for job type ${type}`);\n      }\n\n      if (!hasError) {\n        // Rely on AbortController to prevent items in aborted queues from being marked as complete\n        await markJobCompleteInDatabase(id);\n        this.removeAbortController(id, queueId);\n        this.jobIds.delete(id);\n        this.emit('complete', { id });\n        return;\n      }\n      const job = await getJobFromDatabase(id);\n      if (typeof job === 'undefined') {\n        this.logger.error(`Unable to get ${type} job #${id} in queue ${queueId} following error`);\n        this.removeAbortController(id, queueId);\n        this.jobIds.delete(id);\n        return;\n      }\n      if (job.status === JOB_CLEANUP_STATUS) {\n        throw new Error(`Found cleanup status for ${type} job #${id} in queue ${queueId} following error, this should not happen`);\n      }\n      if (job.status === JOB_COMPLETE_STATUS) {\n        throw new Error(`Found complete status for ${type} job #${id} in queue ${queueId} following error, this should not happen`);\n      }\n      if (job.status === JOB_ERROR_STATUS) {\n        throw new Error(`Found error status for ${type} job #${id} in queue ${queueId} following error, this should not happen`);\n      }\n      if (job.status === JOB_ABORTED_STATUS) {\n        // Job was aborted while running\n        this.logger.error(`Found aborted status for ${type} job #${id} in queue ${queueId} following error, starting cleanup`);\n        await markJobErrorInDatabase(id);\n      } else if (hasFatalError) {\n        await markJobCleanupInDatabase(id);\n        this.emit('fatalError', { queueId });\n        await this.abortQueue(queueId);\n      } else if (delayRetryErrorMs > 0) {\n        const newStartAfter = Date.now() + delayRetryErrorMs;\n        this.logger.warn(`Delaying retry of ${type} job #${id} in queue ${queueId} by ${delayRetryErrorMs}ms to ${new Date(newStartAfter).toLocaleString()} following DelayRetryError`);\n        this.emit('delayRetry', { id, queueId, delay: delayRetryErrorMs });\n        await markJobStartAfterInDatabase(id, newStartAfter);\n        await markJobErrorInDatabase(id);\n      } else {\n        const retryDelayFunction = this.retryDelayMap.get(type);\n        if (typeof retryDelayFunction === 'function') {\n          const delayRetryMs = retryDelayFunction(attempt + 1);\n          if (delayRetryMs > 0) {\n            const newStartAfter = Date.now() + delayRetryMs;\n            this.logger.warn(`Delaying retry of ${type} job #${id} in queue ${queueId} by ${delayRetryMs}ms to ${new Date(newStartAfter).toLocaleString()}`);\n            this.emit('delayRetry', { id, queueId, delay: delayRetryMs });\n            await markJobStartAfterInDatabase(id, newStartAfter);\n          }\n        }\n        await markJobErrorInDatabase(id);\n      }\n      this.removeAbortController(id, queueId);\n      this.jobIds.delete(id);\n      await this.dequeue();\n    };\n    this.addToQueue(queueId, priority, run);\n    this.emit('dequeue', { id });\n  }\n\n  handleInitializationMessage(event:ExtendableMessageEvent) {\n    if (!(event instanceof ExtendableMessageEvent)) {\n      return;\n    }\n    const { data } = event;\n    if (!data || typeof data !== 'object') {\n      return;\n    }\n    const { type } = data;\n    if (type !== 'BATTERY_QUEUE_WORKER_INITIALIZATION') {\n      return;\n    }\n    if (!Array.isArray(event.ports)) {\n      return;\n    }\n    const port = event.ports[0];\n    if (!(port instanceof MessagePort)) {\n      return;\n    }\n    port.postMessage({ type: 'BATTERY_QUEUE_WORKER_CONFIRMATION' });\n    this.logger.info('Linked to interface');\n    port.onmessage = this.handlePortMessage.bind(this);\n    this.emitCallbacks.push((t:string, args:Array<any>) => {\n      port.postMessage({ type: t, args });\n    });\n    this.port = port;\n  }\n\n  async handlePortMessage(event:MessageEvent) {\n    if (!(event instanceof MessageEvent)) {\n      return;\n    }\n    const { data } = event;\n    if (!data || typeof data !== 'object') {\n      this.logger.warn('Invalid message data');\n      this.logger.warnObject(event);\n      return;\n    }\n    const { type, value } = data;\n    if (typeof type !== 'string') {\n      this.logger.warn('Unknown message type');\n      this.logger.warnObject(event);\n      return;\n    }\n    if (value === null || typeof value !== 'object') {\n      throw new Error('Message payload should be an object');\n    }\n    const { id } = value;\n    if (typeof id !== 'number') {\n      throw new Error('Message payload should include property id with type number');\n    }\n    switch (type) {\n      case 'clear':\n        try {\n          await this.clear();\n          this.emit('clearComplete', { id });\n        } catch (error) {\n          this.emit('clearError', { errorObject: errorObjectParser.serializeError(error), id });\n          this.logger.error('Unable to handle clear message');\n          this.logger.errorStack(error);\n        }\n        break;\n      case 'abortQueue':\n        try {\n          const { queueId } = value;\n          if (typeof queueId !== 'string') {\n            throw new Error('Message abort queue payload should include property queueId with type string');\n          }\n          await this.abortQueue(queueId);\n          this.emit('abortQueueComplete', { id });\n        } catch (error) {\n          this.emit('abortQueueError', { errorObject: errorObjectParser.serializeError(error), id });\n          this.logger.error('Unable to handle abort queue message');\n          this.logger.errorStack(error);\n        }\n        break;\n      case 'dequeue':\n        try {\n          await this.dequeue();\n          this.emit('dequeueComplete', { id });\n        } catch (error) {\n          this.emit('dequeueError', { errorObject: errorObjectParser.serializeError(error), id });\n          this.logger.error('Unable to handle dequeue message');\n          this.logger.errorStack(error);\n        }\n        break;\n      case 'idle':\n        try {\n          const { maxDuration, start } = value;\n          if (typeof maxDuration !== 'number') {\n            throw new Error('Message idle payload should include property maxDuration with type number');\n          }\n          if (typeof start !== 'number') {\n            throw new Error('Message idle payload should include property start with type number');\n          }\n          await this.onIdle(maxDuration - (Date.now() - start));\n          this.emit('idleComplete', { id });\n        } catch (error) {\n          this.emit('idleError', { errorObject: errorObjectParser.serializeError(error), id });\n          this.logger.error('Unable to handle idle message');\n          this.logger.errorStack(error);\n        }\n        break;\n      default:\n        this.logger.warn(`Unknown worker interface message type ${type}`);\n    }\n  }\n\n  listenForServiceWorkerInterface() {\n    self.addEventListener('message', this.handleInitializationMessage.bind(this));\n  }\n}\n\n"],"file":"queue.js"}