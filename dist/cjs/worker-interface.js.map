{"version":3,"sources":["../../src/worker-interface.js"],"names":["BatteryQueueServiceWorkerInterface","options","logger","controller","navigator","serviceWorker","ServiceWorker","Error","port","MessagePort","ready","messageChannel","MessageChannel","Promise","resolve","reject","timeout","setTimeout","port1","onmessage","event","MessageEvent","data","warn","warnObject","type","clearTimeout","getController","postMessage","port2","info","args","Array","isArray","emit","maxDuration","link","id","Math","random","removeListener","handleClearComplete","handleClearError","responseId","errorObject","error","errorObjectParser","deserializeError","addListener","value","queueId","handleAbortQueueComplete","handleAbortQueueError","handleDequeueComplete","handleDequeueError","handleIdleComplete","handleIdleError","start","Date","now","EventEmitter"],"mappings":"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","sourcesContent":["// @flow\n\nimport EventEmitter from 'events';\nimport errorObjectParser from 'serialize-error';\nimport type { Logger } from './logger';\nimport makeLogger from './logger';\n\ntype Options = {\n  logger?: Logger\n};\n\nexport default class BatteryQueueServiceWorkerInterface extends EventEmitter {\n  declare serviceWorker: ServiceWorker;\n  declare logger: Logger;\n  declare port: MessagePort | void;\n\n  constructor(options?: Options = {}) {\n    super();\n    this.logger = options.logger || makeLogger('Battery Queue Worker Interface');\n  }\n\n  getController() {\n    const controller = navigator && navigator.serviceWorker && navigator.serviceWorker.controller;\n    if (controller instanceof ServiceWorker) {\n      return controller;\n    }\n    throw new Error('Service worker controller does not exist');\n  }\n\n  async link() {\n    if (this.port instanceof MessagePort) {\n      return this.port;\n    }\n\n    const serviceWorker = navigator && navigator.serviceWorker;\n\n    if (!serviceWorker) {\n      throw new Error('Service worker not available');\n    }\n\n    await serviceWorker.ready;\n\n    const messageChannel = new MessageChannel();\n\n    await new Promise((resolve, reject) => {\n      const timeout = setTimeout(() => {\n        messageChannel.port1.onmessage = null;\n        reject(new Error('Unable to link to service worker'));\n      }, 1000);\n      messageChannel.port1.onmessage = (event:MessageEvent) => {\n        if (!(event instanceof MessageEvent)) {\n          return;\n        }\n        const { data } = event;\n        if (!data || typeof data !== 'object') {\n          this.logger.warn('Unknown message type');\n          this.logger.warnObject(event);\n          return;\n        }\n        const { type } = data;\n        if (typeof type !== 'string') {\n          this.logger.warn('Unknown message type');\n          this.logger.warnObject(event);\n          return;\n        }\n        if (type === 'BATTERY_QUEUE_WORKER_CONFIRMATION') {\n          clearTimeout(timeout);\n          resolve();\n        }\n      };\n      const controller = this.getController();\n      // $FlowFixMe\n      controller.postMessage({ type: 'BATTERY_QUEUE_WORKER_INITIALIZATION' }, [\n        messageChannel.port2,\n      ]);\n    });\n\n    this.logger.info('Linked to worker');\n\n    messageChannel.port1.onmessage = (event:MessageEvent) => {\n      if (!(event instanceof MessageEvent)) {\n        return;\n      }\n      const { data } = event;\n      if (!data || typeof data !== 'object') {\n        this.logger.warn('Invalid message data');\n        this.logger.warnObject(event);\n        return;\n      }\n      const { type, args } = data;\n      if (typeof type !== 'string') {\n        this.logger.warn('Unknown message type');\n        this.logger.warnObject(event);\n        return;\n      }\n      if (!Array.isArray(args)) {\n        this.logger.warn('Unknown arguments type');\n        this.logger.warnObject(event);\n        return;\n      }\n      this.emit(type, ...args);\n    };\n    this.port = messageChannel.port1;\n    return messageChannel.port1;\n  }\n\n  async clear(maxDuration?: number = 1000) {\n    const port = await this.link();\n    await new Promise((resolve, reject) => {\n      const id = Math.random();\n      const timeout = setTimeout(() => {\n        this.removeListener('clearComplete', handleClearComplete);\n        this.removeListener('clearError', handleClearError);\n        reject(new Error(`Did not receive clear response within ${maxDuration}ms`));\n      }, maxDuration);\n      const handleClearComplete = ({ id: responseId }) => {\n        if (id !== responseId) {\n          return;\n        }\n        clearTimeout(timeout);\n        this.removeListener('clearComplete', handleClearComplete);\n        this.removeListener('clearError', handleClearError);\n        resolve();\n      };\n      const handleClearError = ({ id: responseId, errorObject }) => {\n        if (id !== responseId) {\n          return;\n        }\n        clearTimeout(timeout);\n        this.removeListener('clearComplete', handleClearComplete);\n        this.removeListener('clearError', handleClearError);\n        const error = errorObjectParser.deserializeError(errorObject);\n        reject(error);\n      };\n      this.addListener('clearComplete', handleClearComplete);\n      this.addListener('clearError', handleClearError);\n      port.postMessage({ type: 'clear', value: { id } });\n    });\n  }\n\n  async abortQueue(queueId:string, maxDuration?: number = 1000) {\n    const port = await this.link();\n    await new Promise((resolve, reject) => {\n      const id = Math.random();\n      const timeout = setTimeout(() => {\n        this.removeListener('abortQueueComplete', handleAbortQueueComplete);\n        this.removeListener('abortQueueError', handleAbortQueueError);\n        reject(new Error(`Did not receive abort queue response within ${maxDuration}ms`));\n      }, maxDuration);\n      const handleAbortQueueComplete = ({ id: responseId }) => {\n        if (id !== responseId) {\n          return;\n        }\n        clearTimeout(timeout);\n        this.removeListener('abortQueueComplete', handleAbortQueueComplete);\n        this.removeListener('abortQueueError', handleAbortQueueError);\n        resolve();\n      };\n      const handleAbortQueueError = ({ id: responseId, errorObject }) => {\n        if (id !== responseId) {\n          return;\n        }\n        clearTimeout(timeout);\n        this.removeListener('abortQueueComplete', handleAbortQueueComplete);\n        this.removeListener('abortQueueError', handleAbortQueueError);\n        const error = errorObjectParser.deserializeError(errorObject);\n        reject(error);\n      };\n      this.addListener('abortQueueComplete', handleAbortQueueComplete);\n      this.addListener('abortQueueError', handleAbortQueueError);\n      port.postMessage({ type: 'abortQueue', value: { id, queueId } });\n    });\n  }\n\n  async dequeue(maxDuration?: number = 1000) {\n    const port = await this.link();\n    await new Promise((resolve, reject) => {\n      const id = Math.random();\n      const timeout = setTimeout(() => {\n        this.removeListener('dequeueComplete', handleDequeueComplete);\n        this.removeListener('dequeueError', handleDequeueError);\n        reject(new Error(`Did not receive dequeue response within ${maxDuration}ms`));\n      }, maxDuration);\n      const handleDequeueComplete = ({ id: responseId }) => {\n        if (id !== responseId) {\n          return;\n        }\n        clearTimeout(timeout);\n        this.removeListener('dequeueComplete', handleDequeueComplete);\n        this.removeListener('dequeueError', handleDequeueError);\n        resolve();\n      };\n      const handleDequeueError = ({ id: responseId, errorObject }) => {\n        if (id !== responseId) {\n          return;\n        }\n        clearTimeout(timeout);\n        this.removeListener('dequeueComplete', handleDequeueComplete);\n        this.removeListener('dequeueError', handleDequeueError);\n        const error = errorObjectParser.deserializeError(errorObject);\n        reject(error);\n      };\n      this.addListener('dequeueComplete', handleDequeueComplete);\n      this.addListener('dequeueError', handleDequeueError);\n      port.postMessage({ type: 'dequeue', value: { id } });\n    });\n  }\n\n  async onIdle(maxDuration?: number = 1000) {\n    const port = await this.link();\n    await new Promise((resolve, reject) => {\n      const id = Math.random();\n      const timeout = setTimeout(() => {\n        this.removeListener('idleComplete', handleIdleComplete);\n        this.removeListener('idleError', handleIdleError);\n        reject(new Error(`Did not receive idle response within ${maxDuration}ms`));\n      }, maxDuration);\n      const handleIdleComplete = ({ id: responseId }) => {\n        if (id !== responseId) {\n          return;\n        }\n        clearTimeout(timeout);\n        this.removeListener('idleComplete', handleIdleComplete);\n        this.removeListener('idleError', handleIdleError);\n        resolve();\n      };\n      const handleIdleError = ({ id: responseId, errorObject }) => {\n        if (id !== responseId) {\n          return;\n        }\n        clearTimeout(timeout);\n        this.removeListener('idleComplete', handleIdleComplete);\n        this.removeListener('idleError', handleIdleError);\n        const error = errorObjectParser.deserializeError(errorObject);\n        reject(error);\n      };\n      this.addListener('idleComplete', handleIdleComplete);\n      this.addListener('idleError', handleIdleError);\n      port.postMessage({ type: 'idle', value: { id, maxDuration, start: Date.now() } });\n    });\n  }\n}\n"],"file":"worker-interface.js"}