{"version":3,"sources":["../../src/worker-interface.js"],"names":["EventEmitter","makeLogger","jobEmitter","localJobEmitter","canUseSyncManager","navigator","window","RedundantServiceWorkerError","Error","BatteryQueueServiceWorkerInterface","constructor","options","logger","on","isSyncing","getController","serviceWorker","ready","controller","state","warn","Promise","resolve","timeout","setTimeout","removeEventListener","handleControllerChange","clearTimeout","addEventListener","link","port","MessagePort","messageChannel","MessageChannel","port1","handleStateChange","postMessage","type","args","error","errorStack","close","port2","onmessage","emit","self","queueMicrotask","catch","reject","handleStateChangeBeforeLink","event","MessageEvent","data","warnObject","Array","isArray","queueIds","Set","queueId","add","delete","size","handleJobAdd","handleJobDelete","handleJobUpdate","handleJobsClear","addListener","info","clear","maxDuration","requestId","Math","random","removeListener","handleClearComplete","handleClearError","responseId","abortQueue","handleAbortQueueComplete","handleAbortQueueError","dequeue","handleDequeueComplete","handleDequeueError","onIdle","handleIdleComplete","handleIdleError","Date","now","getQueueIds","handleGetQueuesComplete","handleGetQueuesError","qIds","enableStartOnJob","handleEnableStartOnJobComplete","handleEnableStartOnJobError","sync","disableStartOnJob","handledisableStartOnJobComplete","handledisableStartOnJobError","registration","register","handleOnIdleSync","handleIdle","handleUnlink"],"mappings":"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","sourcesContent":["// @flow\n\nimport EventEmitter from 'events';\nimport type { Logger } from './logger';\nimport makeLogger from './logger';\nimport { jobEmitter, localJobEmitter } from './database';\n\ntype Options = {\n  logger?: Logger\n};\n\nconst canUseSyncManager = 'serviceWorker' in navigator && 'SyncManager' in window;\n\nclass RedundantServiceWorkerError extends Error {}\n\nexport default class BatteryQueueServiceWorkerInterface extends EventEmitter {\n  declare serviceWorker: ServiceWorker;\n  declare logger: Logger;\n  declare port: MessagePort | void;\n  declare queueIds: Set<string> | void;\n  declare isSyncing: boolean;\n  declare handleJobAdd: void | () => void;\n\n  constructor(options?: Options = {}) {\n    super();\n    this.logger = options.logger || makeLogger('Battery Queue Worker Interface');\n    // This is a no-op to prevent errors from being thrown in the browser context.\n    // Errors are logged in the worker.\n    this.on('error', () => {});\n    this.isSyncing = false;\n  }\n\n  async getController() {\n    const serviceWorker = navigator && navigator.serviceWorker;\n\n    if (!serviceWorker) {\n      throw new Error('Service worker not available');\n    }\n\n    await serviceWorker.ready;\n\n    const { controller } = serviceWorker;\n\n    if (!controller) {\n      throw new Error('Service worker controller not available');\n    }\n\n    if (controller.state === 'redundant') {\n      this.logger.warn('Service worker in redudant state, waiting for controller change');\n      await new Promise((resolve) => {\n        const timeout = setTimeout(() => {\n          serviceWorker.removeEventListener('controllerchange', handleControllerChange);\n          resolve();\n        }, 5000);\n        const handleControllerChange = () => {\n          clearTimeout(timeout);\n          serviceWorker.removeEventListener('controllerchange', handleControllerChange);\n          resolve();\n        };\n        serviceWorker.addEventListener('controllerchange', handleControllerChange);\n      });\n      return this.getController();\n    }\n\n    return controller;\n  }\n\n  async link() {\n    if (this.port instanceof MessagePort) {\n      return this.port;\n    }\n\n    const controller = await this.getController();\n\n    const messageChannel = new MessageChannel();\n\n    const port = messageChannel.port1;\n\n    const handleStateChange = () => {\n      this.logger.warn(`Service worker state change to ${controller.state}`);\n      if (controller.state !== 'redundant') {\n        return;\n      }\n      this.logger.warn('Unlinking');\n      try {\n        port.postMessage({ type: 'unlink', args: [] });\n      } catch (error) {\n        this.logger.error('Error while posting unlink message to redundant service worker');\n        this.logger.errorStack(error);\n      }\n      try {\n        messageChannel.port1.close();\n        messageChannel.port2.close();\n      } catch (error) {\n        this.logger.error('Error while closing MessageChannel ports with redundant service worker');\n        this.logger.errorStack(error);\n      }\n      messageChannel.port1.onmessage = null;\n      delete this.port;\n      this.emit('unlink');\n      self.queueMicrotask(() => {\n        this.link().catch((error) => {\n          this.logger.error('Unable to re-link service worker');\n          this.logger.errorStack(error);\n        });\n      });\n    };\n\n    controller.addEventListener('statechange', handleStateChange);\n\n    try {\n      await new Promise((resolve, reject) => {\n        const timeout = setTimeout(() => {\n          messageChannel.port1.onmessage = null;\n          controller.removeEventListener('statechange', handleStateChange);\n          controller.removeEventListener('statechange', handleStateChangeBeforeLink);\n          reject(new Error('Unable to link to service worker'));\n        }, 1000);\n        const handleStateChangeBeforeLink = () => {\n          if (controller.state !== 'redundant') {\n            return;\n          }\n          clearTimeout(timeout);\n          controller.removeEventListener('statechange', handleStateChangeBeforeLink);\n          reject(new RedundantServiceWorkerError('Service worker in redundant state'));\n        };\n        controller.addEventListener('statechange', handleStateChangeBeforeLink);\n        messageChannel.port1.onmessage = (event:MessageEvent) => {\n          if (!(event instanceof MessageEvent)) {\n            return;\n          }\n          const { data } = event;\n          if (!data || typeof data !== 'object') {\n            this.logger.warn('Unknown message type');\n            this.logger.warnObject(event);\n            return;\n          }\n          const { type } = data;\n          if (typeof type !== 'string') {\n            this.logger.warn('Unknown message type');\n            this.logger.warnObject(event);\n            return;\n          }\n          if (type === 'BATTERY_QUEUE_WORKER_CONFIRMATION') {\n            clearTimeout(timeout);\n            controller.removeEventListener('statechange', handleStateChangeBeforeLink);\n            resolve();\n          }\n        };\n        // $FlowFixMe\n        controller.postMessage({ type: 'BATTERY_QUEUE_WORKER_INITIALIZATION' }, [\n          messageChannel.port2,\n        ]);\n      });\n    } catch (error) {\n      if (error instanceof RedundantServiceWorkerError) {\n        return messageChannel.port1;\n      }\n      controller.removeEventListener('statechange', handleStateChange);\n      throw error;\n    }\n\n    messageChannel.port1.onmessage = (event:MessageEvent) => {\n      if (!(event instanceof MessageEvent)) {\n        return;\n      }\n      const { data } = event;\n      if (!data || typeof data !== 'object') {\n        this.logger.warn('Invalid message data');\n        this.logger.warnObject(event);\n        return;\n      }\n      const { type, args } = data;\n      if (typeof type !== 'string') {\n        this.logger.warn('Unknown message type');\n        this.logger.warnObject(event);\n        return;\n      }\n      if (!Array.isArray(args)) {\n        this.logger.warn('Unknown arguments type');\n        this.logger.warnObject(event);\n        return;\n      }\n      const queueIds = this.queueIds;\n      switch (type) {\n        case 'jobAdd':\n          jobEmitter.emit('jobAdd', ...args);\n          return;\n        case 'jobDelete':\n          jobEmitter.emit('jobDelete', ...args);\n          return;\n        case 'jobUpdate':\n          jobEmitter.emit('jobUpdate', ...args);\n          return;\n        case 'jobsClear':\n          jobEmitter.emit('jobsClear', ...args);\n          return;\n        case 'queueActive':\n          if (queueIds instanceof Set) {\n            const queueId = args[0];\n            if (typeof queueId === 'string') {\n              queueIds.add(queueId);\n            }\n          }\n          break;\n        case 'queueInactive':\n          if (queueIds instanceof Set) {\n            const queueId = args[0];\n            if (typeof queueId === 'string') {\n              queueIds.delete(queueId);\n              if (queueIds.size === 0) {\n                delete this.queueIds;\n              }\n            }\n          }\n          break;\n        default:\n          break;\n      }\n      this.emit(type, ...args);\n    };\n\n\n    const handleJobAdd = (...args:Array<any>) => {\n      port.postMessage({ type: 'jobAdd', args });\n    };\n    const handleJobDelete = (...args:Array<any>) => {\n      port.postMessage({ type: 'jobDelete', args });\n    };\n    const handleJobUpdate = (...args:Array<any>) => {\n      port.postMessage({ type: 'jobUpdate', args });\n    };\n    const handleJobsClear = (...args:Array<any>) => {\n      port.postMessage({ type: 'jobsClear', args });\n    };\n    localJobEmitter.addListener('jobAdd', handleJobAdd);\n    localJobEmitter.addListener('jobDelete', handleJobDelete);\n    localJobEmitter.addListener('jobUpdate', handleJobUpdate);\n    localJobEmitter.addListener('jobsClear', handleJobsClear);\n\n    this.port = messageChannel.port1;\n\n    this.logger.info('Linked to worker');\n    this.emit('link');\n    return messageChannel.port1;\n  }\n\n  async clear(maxDuration?: number = 1000) {\n    const port = await this.link();\n    await new Promise((resolve, reject) => {\n      const requestId = Math.random();\n      const timeout = setTimeout(() => {\n        this.removeListener('clearComplete', handleClearComplete);\n        this.removeListener('clearError', handleClearError);\n        reject(new Error(`Did not receive clear response within ${maxDuration}ms`));\n      }, maxDuration);\n      const handleClearComplete = (responseId:number) => {\n        if (responseId !== requestId) {\n          return;\n        }\n        clearTimeout(timeout);\n        this.removeListener('clearComplete', handleClearComplete);\n        this.removeListener('clearError', handleClearError);\n        resolve();\n      };\n      const handleClearError = (responseId:number, error:Error) => {\n        if (responseId !== requestId) {\n          return;\n        }\n        clearTimeout(timeout);\n        this.removeListener('clearComplete', handleClearComplete);\n        this.removeListener('clearError', handleClearError);\n        reject(error);\n      };\n      this.addListener('clearComplete', handleClearComplete);\n      this.addListener('clearError', handleClearError);\n      port.postMessage({ type: 'clear', args: [requestId] });\n    });\n  }\n\n  async abortQueue(queueId:string, maxDuration?: number = 1000) {\n    const port = await this.link();\n    await new Promise((resolve, reject) => {\n      const requestId = Math.random();\n      const timeout = setTimeout(() => {\n        this.removeListener('abortQueueComplete', handleAbortQueueComplete);\n        this.removeListener('abortQueueError', handleAbortQueueError);\n        reject(new Error(`Did not receive abort queue response within ${maxDuration}ms`));\n      }, maxDuration);\n      const handleAbortQueueComplete = (responseId:number) => {\n        if (responseId !== requestId) {\n          return;\n        }\n        clearTimeout(timeout);\n        this.removeListener('abortQueueComplete', handleAbortQueueComplete);\n        this.removeListener('abortQueueError', handleAbortQueueError);\n        resolve();\n      };\n      const handleAbortQueueError = (responseId:number, error:Error) => {\n        if (responseId !== requestId) {\n          return;\n        }\n        clearTimeout(timeout);\n        this.removeListener('abortQueueComplete', handleAbortQueueComplete);\n        this.removeListener('abortQueueError', handleAbortQueueError);\n        reject(error);\n      };\n      this.addListener('abortQueueComplete', handleAbortQueueComplete);\n      this.addListener('abortQueueError', handleAbortQueueError);\n      port.postMessage({ type: 'abortQueue', args: [requestId, queueId] });\n    });\n  }\n\n  async dequeue(maxDuration?: number = 1000) {\n    const port = await this.link();\n    await new Promise((resolve, reject) => {\n      const requestId = Math.random();\n      const timeout = setTimeout(() => {\n        this.removeListener('dequeueComplete', handleDequeueComplete);\n        this.removeListener('dequeueError', handleDequeueError);\n        reject(new Error(`Did not receive dequeue response within ${maxDuration}ms`));\n      }, maxDuration);\n      const handleDequeueComplete = (responseId:number) => {\n        if (responseId !== requestId) {\n          return;\n        }\n        clearTimeout(timeout);\n        this.removeListener('dequeueComplete', handleDequeueComplete);\n        this.removeListener('dequeueError', handleDequeueError);\n        resolve();\n      };\n      const handleDequeueError = (responseId:number, error:Error) => {\n        if (responseId !== requestId) {\n          return;\n        }\n        clearTimeout(timeout);\n        this.removeListener('dequeueComplete', handleDequeueComplete);\n        this.removeListener('dequeueError', handleDequeueError);\n        reject(error);\n      };\n      this.addListener('dequeueComplete', handleDequeueComplete);\n      this.addListener('dequeueError', handleDequeueError);\n      port.postMessage({ type: 'dequeue', args: [requestId] });\n    });\n  }\n\n  async onIdle(maxDuration?: number = 1000) {\n    const port = await this.link();\n    await new Promise((resolve, reject) => {\n      const requestId = Math.random();\n      const timeout = setTimeout(() => {\n        this.removeListener('idleComplete', handleIdleComplete);\n        this.removeListener('idleError', handleIdleError);\n        reject(new Error(`Did not receive idle response within ${maxDuration}ms`));\n      }, maxDuration);\n      const handleIdleComplete = (responseId:number) => {\n        if (responseId !== requestId) {\n          return;\n        }\n        clearTimeout(timeout);\n        this.removeListener('idleComplete', handleIdleComplete);\n        this.removeListener('idleError', handleIdleError);\n        resolve();\n      };\n      const handleIdleError = (responseId:number, error:Error) => {\n        if (responseId !== requestId) {\n          return;\n        }\n        clearTimeout(timeout);\n        this.removeListener('idleComplete', handleIdleComplete);\n        this.removeListener('idleError', handleIdleError);\n        reject(error);\n      };\n      this.addListener('idleComplete', handleIdleComplete);\n      this.addListener('idleError', handleIdleError);\n      port.postMessage({ type: 'idle', args: [requestId, maxDuration, Date.now()] });\n    });\n  }\n\n  async getQueueIds(maxDuration?: number = 1000) {\n    if (this.queueIds instanceof Set) {\n      return this.queueIds;\n    }\n    const port = await this.link();\n    const queueIds = await new Promise((resolve, reject) => {\n      const requestId = Math.random();\n      const timeout = setTimeout(() => {\n        this.removeListener('getQueuesComplete', handleGetQueuesComplete);\n        this.removeListener('getQueuesError', handleGetQueuesError);\n        reject(new Error(`Did not receive idle response within ${maxDuration}ms`));\n      }, maxDuration);\n      const handleGetQueuesComplete = (responseId:number, qIds:Array<string>) => {\n        if (responseId !== requestId) {\n          return;\n        }\n        clearTimeout(timeout);\n        this.removeListener('getQueuesComplete', handleGetQueuesComplete);\n        this.removeListener('getQueuesError', handleGetQueuesError);\n        resolve((new Set(qIds): Set<string>));\n      };\n      const handleGetQueuesError = (responseId:number, error:Error) => {\n        if (responseId !== requestId) {\n          return;\n        }\n        clearTimeout(timeout);\n        this.removeListener('getQueuesComplete', handleGetQueuesComplete);\n        this.removeListener('getQueuesError', handleGetQueuesError);\n        reject(error);\n      };\n      this.addListener('getQueuesComplete', handleGetQueuesComplete);\n      this.addListener('getQueuesError', handleGetQueuesError);\n      port.postMessage({ type: 'getQueueIds', args: [requestId] });\n    });\n    if (queueIds.size > 0) {\n      this.queueIds = queueIds;\n    }\n    return queueIds;\n  }\n\n  async enableStartOnJob(maxDuration?: number = 1000) {\n    const port = await this.link();\n    await new Promise((resolve, reject) => {\n      const requestId = Math.random();\n      const timeout = setTimeout(() => {\n        this.removeListener('enableStartOnJobComplete', handleEnableStartOnJobComplete);\n        this.removeListener('enableStartOnJobError', handleEnableStartOnJobError);\n        reject(new Error(`Did not receive enableStartOnJob response within ${maxDuration}ms`));\n      }, maxDuration);\n      const handleEnableStartOnJobComplete = (responseId:number) => {\n        if (responseId !== requestId) {\n          return;\n        }\n        clearTimeout(timeout);\n        this.removeListener('enableStartOnJobComplete', handleEnableStartOnJobComplete);\n        this.removeListener('enableStartOnJobError', handleEnableStartOnJobError);\n        resolve();\n      };\n      const handleEnableStartOnJobError = (responseId:number, error:Error) => {\n        if (responseId !== requestId) {\n          return;\n        }\n        clearTimeout(timeout);\n        this.removeListener('enableStartOnJobComplete', handleEnableStartOnJobComplete);\n        this.removeListener('enableStartOnJobError', handleEnableStartOnJobError);\n        reject(error);\n      };\n      this.addListener('enableStartOnJobComplete', handleEnableStartOnJobComplete);\n      this.addListener('enableStartOnJobError', handleEnableStartOnJobError);\n      port.postMessage({ type: 'enableStartOnJob', args: [requestId] });\n    });\n    const handleJobAdd = () => {\n      this.sync();\n    };\n    jobEmitter.addListener('jobAdd', handleJobAdd);\n    this.handleJobAdd = handleJobAdd;\n  }\n\n  async disableStartOnJob(maxDuration?: number = 1000) {\n    const handleJobAdd = this.handleJobAdd;\n    if (typeof handleJobAdd === 'function') {\n      jobEmitter.removeListener('jobAdd', handleJobAdd);\n    }\n    const port = await this.link();\n    await new Promise((resolve, reject) => {\n      const requestId = Math.random();\n      const timeout = setTimeout(() => {\n        this.removeListener('disableStartOnJobComplete', handledisableStartOnJobComplete);\n        this.removeListener('disableStartOnJobError', handledisableStartOnJobError);\n        reject(new Error(`Did not receive disableStartOnJob response within ${maxDuration}ms`));\n      }, maxDuration);\n      const handledisableStartOnJobComplete = (responseId:number) => {\n        if (responseId !== requestId) {\n          return;\n        }\n        clearTimeout(timeout);\n        this.removeListener('disableStartOnJobComplete', handledisableStartOnJobComplete);\n        this.removeListener('disableStartOnJobError', handledisableStartOnJobError);\n        resolve();\n      };\n      const handledisableStartOnJobError = (responseId:number, error:Error) => {\n        if (responseId !== requestId) {\n          return;\n        }\n        clearTimeout(timeout);\n        this.removeListener('disableStartOnJobComplete', handledisableStartOnJobComplete);\n        this.removeListener('disableStartOnJobError', handledisableStartOnJobError);\n        reject(error);\n      };\n      this.addListener('disableStartOnJobComplete', handledisableStartOnJobComplete);\n      this.addListener('disableStartOnJobError', handledisableStartOnJobError);\n      port.postMessage({ type: 'disableStartOnJob', args: [requestId] });\n    });\n  }\n\n  async sync() {\n    if (!canUseSyncManager) {\n      return;\n    }\n    if (this.isSyncing) {\n      return;\n    }\n    this.isSyncing = true;\n    try {\n      await this.link();\n      this.logger.info('Sending sync event');\n      const serviceWorker = navigator && navigator.serviceWorker;\n      if (!serviceWorker) {\n        throw new Error('Service worker not available');\n      }\n      const registration = await serviceWorker.ready;\n      // $FlowFixMe\n      registration.sync.register('syncManagerOnIdle');\n      await new Promise((resolve, reject) => {\n        const timeout = setTimeout(() => {\n          this.removeListener('syncManagerOnIdle', handleOnIdleSync);\n          reject(new Error('Unable to sync, did not receive syncManagerOnIdle acknowledgement'));\n        }, 5000);\n        const handleOnIdleSync = () => {\n          clearTimeout(timeout);\n          this.removeListener('syncManagerOnIdle', handleOnIdleSync);\n          resolve();\n        };\n        this.addListener('syncManagerOnIdle', handleOnIdleSync);\n      });\n      await new Promise((resolve) => {\n        const handleIdle = () => {\n          this.removeListener('idle', handleIdle);\n          this.removeListener('unlink', handleUnlink);\n          resolve();\n        };\n        const handleUnlink = () => {\n          this.removeListener('idle', handleIdle);\n          this.removeListener('unlink', handleUnlink);\n          resolve();\n        };\n        this.addListener('idle', handleIdle);\n        this.addListener('unlink', handleUnlink);\n      });\n    } catch (error) {\n      this.logger.error('Unable to sync');\n      this.emit('error', error);\n      this.logger.errorStack(error);\n    }\n    this.isSyncing = false;\n  }\n}\n"],"file":"worker-interface.js"}