{"version":3,"sources":["../../src/queue-watcher.js"],"names":["EventEmitter","getQueueStatus","jobEmitter","JOB_ABORTED_STATUS","JOB_COMPLETE_STATUS","JOB_PENDING_STATUS","JOB_ERROR_STATUS","JOB_CLEANUP_STATUS","QUEUE_ERROR_STATUS","QUEUE_PENDING_STATUS","QUEUE_EMPTY_STATUS","BatteryQueueWatcher","constructor","queueId","statusRequested","handleJobAdd","id","qId","emit","addListener","handleJobDelete","emitStatus","handleJobUpdate","status","handleJobsClear","didEmitNewStatus","handleStatus","self","queueMicrotask","removeListener","close"],"mappings":"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","sourcesContent":["// @flow\n\nimport EventEmitter from 'events';\nimport {\n  getQueueStatus,\n  jobEmitter,\n  JOB_ABORTED_STATUS,\n  JOB_COMPLETE_STATUS,\n  JOB_PENDING_STATUS,\n  JOB_ERROR_STATUS,\n  JOB_CLEANUP_STATUS,\n  QUEUE_ERROR_STATUS,\n  QUEUE_PENDING_STATUS,\n  QUEUE_EMPTY_STATUS,\n} from './database';\n\n\nexport default class BatteryQueueWatcher extends EventEmitter {\n  declare queueId: string;\n  declare statusRequested: boolean;\n  declare handleJobAdd: (number, string) => void;\n  declare handleJobDelete: (number, string) => void;\n  declare handleJobUpdate: (number, string, number) => void;\n  declare handleJobsClear: () => void;\n\n  constructor(queueId: string) {\n    super();\n    this.queueId = queueId;\n    this.statusRequested = false;\n    const handleJobAdd = (id:number, qId:string) => {\n      if (queueId !== qId) {\n        return;\n      }\n      this.emit('status', QUEUE_PENDING_STATUS);\n    };\n    this.handleJobAdd = handleJobAdd;\n    jobEmitter.addListener('jobAdd', handleJobAdd);\n    const handleJobDelete = (id:number, qId:string) => {\n      if (queueId !== qId) {\n        return;\n      }\n      this.emitStatus();\n    };\n    this.handleJobDelete = handleJobDelete;\n    jobEmitter.addListener('jobDelete', handleJobDelete);\n    const handleJobUpdate = (id:number, qId:string, status:number) => {\n      if (queueId !== qId) {\n        return;\n      }\n      if (status === JOB_ABORTED_STATUS || status === JOB_CLEANUP_STATUS) {\n        this.emit('status', QUEUE_ERROR_STATUS);\n      } else if (status === JOB_ERROR_STATUS || status === JOB_PENDING_STATUS) {\n        this.emit('status', QUEUE_PENDING_STATUS);\n      } else if (status === JOB_COMPLETE_STATUS || status === JOB_PENDING_STATUS) {\n        this.emitStatus();\n      }\n    };\n    this.handleJobUpdate = handleJobUpdate;\n    jobEmitter.addListener('jobUpdate', handleJobUpdate);\n    const handleJobsClear = () => {\n      this.emit('status', QUEUE_EMPTY_STATUS);\n    };\n    this.handleJobsClear = handleJobsClear;\n    jobEmitter.addListener('jobsClear', handleJobsClear);\n  }\n\n  emitStatus() {\n    if (this.statusRequested) {\n      return;\n    }\n    this.statusRequested = true;\n    let didEmitNewStatus = false;\n    const handleStatus = () => {\n      didEmitNewStatus = true;\n    };\n    this.addListener('status', handleStatus);\n    self.queueMicrotask(async () => {\n      this.statusRequested = false;\n      this.removeListener('status', handleStatus);\n      if (didEmitNewStatus) {\n        return;\n      }\n      const status = await getQueueStatus(this.queueId);\n      this.emit('status', status);\n    });\n  }\n\n  close() {\n    jobEmitter.removeListener('jobAdd', this.handleJobAdd);\n    jobEmitter.removeListener('jobDelete', this.handleJobDelete);\n    jobEmitter.removeListener('jobUpdate', this.handleJobUpdate);\n    jobEmitter.removeListener('jobsClear', this.handleJobsClear);\n  }\n}\n"],"file":"queue-watcher.js"}