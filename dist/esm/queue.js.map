{"version":3,"sources":["../../src/queue.js"],"names":["PQueue","EventEmitter","makeLogger","jobEmitter","localJobEmitter","clearDatabase","dequeueFromDatabase","dequeueFromDatabaseNotIn","incrementJobAttemptInDatabase","incrementCleanupAttemptInDatabase","markJobCompleteInDatabase","markJobPendingInDatabase","markJobErrorInDatabase","markJobStartAfterInDatabase","markJobAsAbortedOrRemoveFromDatabase","markCleanupStartAfterInDatabase","updateCleanupValuesInDatabase","getCleanupFromDatabase","removePathFromCleanupDataInDatabase","getJobFromDatabase","markQueueForCleanupInDatabase","removeCleanupFromDatabase","restoreJobToDatabaseForCleanupAndRemove","JOB_PENDING_STATUS","JOB_ERROR_STATUS","JOB_CLEANUP_STATUS","JOB_CLEANUP_AND_REMOVE_STATUS","AbortError","PRIORITY_OFFSET","Math","floor","Number","MAX_SAFE_INTEGER","BatteryQueue","constructor","options","dequeueQueue","concurrency","handlerMap","Map","cleanupMap","retryJobDelayMap","retryCleanupDelayMap","queueMap","jobIds","Set","abortControllerMap","isClearing","emitCallbacks","logger","addListener","error","errorStack","heartbeatExpiresTimeout","interval","clearTimeout","heartbeatExpiresTimestamp","Date","now","round","setTimeout","warn","unloadClient","enableStartOnJob","disableStartOnJob","didRequestJobAddDequeue","handleJobAdd","self","queueMicrotask","dequeue","handleJobDelete","id","queueId","has","queueAbortControllerMap","get","abortController","abort","handleJobUpdate","type","status","then","job","args","startCleanup","catch","removeListener","emit","emitCallback","getQueueIds","queueIds","keys","setRetryJobDelay","retryJobDelayFunction","Error","set","removeRetryJobDelay","delete","getRetryJobDelay","attempt","result","retryDelayError","setRetryCleanupDelay","retryCleanupDelayFunction","removeRetryCleanupDelay","getRetryCleanupDelay","setHandler","handler","removeHandler","setCleanup","cleanup","removeCleanup","clear","onIdle","start","addToQueue","priority","func","queue","add","newQueue","autoStart","on","Promise","resolve","timeout","handleClearing","handleActive","pending","size","abortQueue","info","values","jobs","startJobs","bind","newJobs","Array","isArray","startAfter","pause","startJob","startErrorHandler","maxDuration","onIdlePromise","setInterval","clearInterval","jobsInterval","length","getAbortController","newAbortController","AbortController","removeAbortController","runCleanup","cleanupJob","data","undefined","delay","toLocaleString","path","name","retryCleanupDelay","newStartAfter","run","signal","aborted","delayJobStart","duration","reject","removeEventListener","handleAbort","addEventListener","updateCleanupData","handlerDidRun","retryDelay","handlePortMessage","event","MessageEvent","warnObject","port","MessagePort","onmessage","requestId","requestArgs","handleHeartbeat","listenForServiceWorkerInterface","activeEmitCallback","handleJobsClear","tag","lastChance","waitUntil","ExtendableMessageEvent","ports","filter","x","previousPort","close","postMessage","t","push","errorObject"],"mappings":"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","sourcesContent":["// @flow\n\nimport PQueue from 'p-queue';\nimport EventEmitter from 'events';\nimport type { Logger } from './logger';\nimport makeLogger from './logger';\nimport type { Job } from './database';\nimport {\n  jobEmitter,\n  localJobEmitter,\n  clearDatabase,\n  dequeueFromDatabase,\n  dequeueFromDatabaseNotIn,\n  incrementJobAttemptInDatabase,\n  incrementCleanupAttemptInDatabase,\n  markJobCompleteInDatabase,\n  markJobPendingInDatabase,\n  markJobErrorInDatabase,\n  markJobStartAfterInDatabase,\n  markJobAsAbortedOrRemoveFromDatabase,\n  markCleanupStartAfterInDatabase,\n  updateCleanupValuesInDatabase,\n  getCleanupFromDatabase,\n  removePathFromCleanupDataInDatabase,\n  getJobFromDatabase,\n  markQueueForCleanupInDatabase,\n  removeCleanupFromDatabase,\n  restoreJobToDatabaseForCleanupAndRemove,\n  JOB_PENDING_STATUS,\n  JOB_ERROR_STATUS,\n  JOB_CLEANUP_STATUS,\n  JOB_CLEANUP_AND_REMOVE_STATUS,\n} from './database';\nimport { AbortError } from './errors';\n\nconst PRIORITY_OFFSET = Math.floor(Number.MAX_SAFE_INTEGER / 2);\n\ntype HandlerFunction = (Array<any>, AbortSignal, (Object) => Promise<void>) => Promise<void>;\ntype CleanupFunction = (Object | void, Array<any>, Array<string> => Promise<void>) => Promise<void>;\ntype RetryDelayFunction = (number, Error) => number | false | Promise<number | false>;\ntype EmitCallback = (string, Array<any>) => void;\n\ntype Options = {\n  logger?: Logger,\n  startOnJob?: boolean\n};\n\nexport default class BatteryQueue extends EventEmitter {\n  declare logger: Logger;\n  declare dequeueQueue: PQueue;\n  declare handlerMap: Map<string, HandlerFunction>;\n  declare retryJobDelayMap: Map<string, RetryDelayFunction>;\n  declare retryCleanupDelayMap: Map<string, RetryDelayFunction>;\n  declare cleanupMap: Map<string, CleanupFunction>;\n  declare queueMap: Map<string, PQueue>;\n  declare abortControllerMap: Map<string, Map<number, AbortController>>;\n  declare isClearing: boolean;\n  declare onIdlePromise: Promise<void> | void;\n  declare jobIds: Set<number>;\n  declare emitCallbacks: Array<EmitCallback>;\n  declare port: MessagePort | void;\n  declare handleJobAdd: void | () => void;\n  declare handleJobUpdate: void | (number, string, string, number) => void;\n  declare handleJobDelete: void | (number, string) => void;\n  declare heartbeatExpiresTimestamp: void | number;\n\n  constructor(options?: Options = {}) {\n    super();\n    this.dequeueQueue = new PQueue({ concurrency: 1 });\n    this.handlerMap = new Map();\n    this.cleanupMap = new Map();\n    this.retryJobDelayMap = new Map();\n    this.retryCleanupDelayMap = new Map();\n    this.queueMap = new Map();\n    this.jobIds = new Set();\n    this.abortControllerMap = new Map();\n    this.isClearing = false;\n    this.emitCallbacks = [];\n    this.logger = options.logger || makeLogger('Battery Queue');\n    this.addListener('error', (error) => {\n      this.logger.errorStack(error);\n    });\n    let heartbeatExpiresTimeout;\n    this.addListener('heartbeat', (interval:number) => {\n      clearTimeout(heartbeatExpiresTimeout);\n      this.heartbeatExpiresTimestamp = Date.now() + Math.round(interval * 2.5);\n      heartbeatExpiresTimeout = setTimeout(() => {\n        if (typeof this.heartbeatExpiresTimestamp !== 'number') {\n          return;\n        }\n        this.logger.warn(`Heartbeat timeout after ${Math.round(interval * 2.1)}ms`);\n        this.unloadClient();\n      }, Math.round(interval * 2.1));\n    });\n  }\n\n  enableStartOnJob() {\n    this.disableStartOnJob(); // Prevent handlers from being added multiple times\n    let didRequestJobAddDequeue = false;\n    const handleJobAdd = () => {\n      if (didRequestJobAddDequeue) {\n        return;\n      }\n      didRequestJobAddDequeue = true;\n      self.queueMicrotask(() => {\n        didRequestJobAddDequeue = false;\n        this.dequeue();\n      });\n    };\n    jobEmitter.addListener('jobAdd', handleJobAdd);\n    this.handleJobAdd = handleJobAdd;\n    const handleJobDelete = (id:number, queueId:string) => {\n      if (this.jobIds.has(id)) {\n        const queueAbortControllerMap = this.abortControllerMap.get(queueId);\n        if (typeof queueAbortControllerMap !== 'undefined') {\n          const abortController = queueAbortControllerMap.get(id);\n          if (typeof abortController !== 'undefined') {\n            abortController.abort();\n          }\n        }\n      }\n    };\n    jobEmitter.addListener('jobDelete', handleJobDelete);\n    this.handleJobDelete = handleJobDelete;\n\n    const handleJobUpdate = (id:number, queueId:string, type:string, status:number) => {\n      if (status !== JOB_CLEANUP_AND_REMOVE_STATUS) {\n        return;\n      }\n      if (this.jobIds.has(id)) {\n        const queueAbortControllerMap = this.abortControllerMap.get(queueId);\n        if (typeof queueAbortControllerMap !== 'undefined') {\n          const abortController = queueAbortControllerMap.get(id);\n          if (typeof abortController !== 'undefined') {\n            abortController.abort();\n          }\n        }\n        return;\n      }\n      getJobFromDatabase(id).then((job:Job | void) => {\n        if (typeof job === 'undefined') {\n          this.logger.error(`Unable to cleanup and remove ${type} job #${id} in queue ${queueId}, job does not exist`);\n          return;\n        }\n        if (this.jobIds.has(id)) {\n          return;\n        }\n        const { args } = job;\n        this.startCleanup(id, queueId, args, type);\n      }).catch((error) => {\n        this.logger.error(`Error while cleaning up and removing ${type} job #${id} in queue ${queueId}`);\n        this.logger.errorStack(error);\n      });\n    };\n    jobEmitter.addListener('jobUpdate', handleJobUpdate);\n    this.handleJobUpdate = handleJobUpdate;\n  }\n\n  disableStartOnJob() {\n    const handleJobAdd = this.handleJobAdd;\n    if (typeof handleJobAdd === 'function') {\n      jobEmitter.removeListener('jobAdd', handleJobAdd);\n      delete this.handleJobAdd;\n    }\n    const handleJobUpdate = this.handleJobUpdate;\n    if (typeof handleJobUpdate === 'function') {\n      jobEmitter.removeListener('jobUpdate', handleJobUpdate);\n      delete this.handleJobUpdate;\n    }\n    const handleJobDelete = this.handleJobDelete;\n    if (typeof handleJobDelete === 'function') {\n      jobEmitter.removeListener('jobDelete', handleJobDelete);\n      delete this.handleJobDelete;\n    }\n  }\n\n  emit(type:string, ...args:Array<any>) {\n    for (const emitCallback of this.emitCallbacks) {\n      emitCallback(type, args);\n    }\n    return super.emit(type, ...args);\n  }\n\n  async getQueueIds() {\n    await this.dequeue();\n    const queueIds:Set<string> = new Set(this.queueMap.keys());\n    return queueIds;\n  }\n\n  setRetryJobDelay(type:string, retryJobDelayFunction:RetryDelayFunction) {\n    if (this.retryJobDelayMap.has(type)) {\n      throw new Error(`Retry job delay handler for type \"${type}\" already exists`);\n    }\n    this.retryJobDelayMap.set(type, retryJobDelayFunction);\n  }\n\n  removeRetryJobDelay(type:string) {\n    if (!this.retryJobDelayMap.has(type)) {\n      throw new Error(`Retry job delay handler for type \"${type}\" does not exist`);\n    }\n    this.retryJobDelayMap.delete(type);\n  }\n\n  async getRetryJobDelay(type:string, attempt: number, error:Error) {\n    const retryJobDelayFunction = this.retryJobDelayMap.get(type);\n    if (typeof retryJobDelayFunction !== 'function') {\n      return false;\n    }\n    let result = false;\n    try {\n      result = await retryJobDelayFunction(attempt, error);\n    } catch (retryDelayError) {\n      this.logger.error(`Error in retry job delay handler for type \"${type}\" on attempt ${attempt}`);\n      this.emit('error', retryDelayError);\n      return false;\n    }\n    if (typeof result !== 'number' && result !== false) {\n      throw new Error(`Retry job delay function for type \"${type}\" returned invalid response, should be a number (milliseconds) or false`);\n    }\n    return result;\n  }\n\n  setRetryCleanupDelay(type:string, retryCleanupDelayFunction:RetryDelayFunction) {\n    if (this.retryCleanupDelayMap.has(type)) {\n      throw new Error(`Retry cleanup delay handler for type \"${type}\" already exists`);\n    }\n    this.retryCleanupDelayMap.set(type, retryCleanupDelayFunction);\n  }\n\n  removeRetryCleanupDelay(type:string) {\n    if (!this.retryCleanupDelayMap.has(type)) {\n      throw new Error(`Retry cleanup delay handler for type \"${type}\" does not exist`);\n    }\n    this.retryCleanupDelayMap.delete(type);\n  }\n\n  async getRetryCleanupDelay(type:string, attempt: number, error:Error) {\n    const retryCleanupDelayFunction = this.retryCleanupDelayMap.get(type);\n    if (typeof retryCleanupDelayFunction !== 'function') {\n      return false;\n    }\n    let result = false;\n    try {\n      result = await retryCleanupDelayFunction(attempt, error);\n    } catch (retryDelayError) {\n      this.logger.error(`Error in retry cleanup delay handler for type \"${type}\" on attempt ${attempt}`);\n      this.emit('error', retryDelayError);\n      return false;\n    }\n    if (typeof result !== 'number' && result !== false) {\n      throw new Error(`Retry cleanup delay function for type \"${type}\" returned invalid response, should be a number (milliseconds) or false`);\n    }\n    return result;\n  }\n\n  setHandler(type:string, handler: HandlerFunction) {\n    if (this.handlerMap.has(type)) {\n      throw new Error(`Handler for type \"${type}\" already exists`);\n    }\n    this.handlerMap.set(type, handler);\n  }\n\n  removeHandler(type:string) {\n    if (!this.handlerMap.has(type)) {\n      throw new Error(`Handler for type \"${type}\" does not exist`);\n    }\n    this.handlerMap.delete(type);\n  }\n\n  setCleanup(type:string, cleanup: CleanupFunction) {\n    if (this.cleanupMap.has(type)) {\n      throw new Error(`Cleanup for type \"${type}\" already exists`);\n    }\n    this.cleanupMap.set(type, cleanup);\n  }\n\n  removeCleanup(type:string) {\n    if (!this.cleanupMap.has(type)) {\n      throw new Error(`Cleanup for type \"${type}\" does not exist`);\n    }\n    this.cleanupMap.delete(type);\n  }\n\n  async clear() {\n    this.isClearing = true;\n    await this.onIdle();\n    this.emit('clearing');\n    await clearDatabase();\n    this.dequeueQueue.start();\n    this.isClearing = false;\n  }\n\n  addToQueue(queueId:string, priority: number, func: () => Promise<void>) {\n    const queue = this.queueMap.get(queueId);\n    if (typeof queue !== 'undefined') {\n      queue.add(func, { priority });\n      return;\n    }\n    const newQueue = new PQueue({ concurrency: 1, autoStart: false });\n    this.queueMap.set(queueId, newQueue);\n    newQueue.add(func, { priority });\n    newQueue.on('idle', async () => {\n      if (!this.isClearing) {\n        await new Promise((resolve) => {\n          const timeout = setTimeout(() => {\n            this.removeListener('clearing', handleClearing);\n            newQueue.removeListener('active', handleActive);\n            resolve();\n          }, 5000);\n          const handleClearing = () => {\n            clearTimeout(timeout);\n            this.removeListener('clearing', handleClearing);\n            newQueue.removeListener('active', handleActive);\n            resolve();\n          };\n          const handleActive = () => {\n            clearTimeout(timeout);\n            this.removeListener('clearing', handleClearing);\n            newQueue.removeListener('active', handleActive);\n            resolve();\n          };\n          this.addListener('clearing', handleClearing);\n          newQueue.addListener('active', handleActive);\n        });\n      }\n      if (newQueue.pending > 0 || newQueue.size > 0) {\n        return;\n      }\n      this.queueMap.delete(queueId);\n      this.emit('queueInactive', queueId);\n    });\n    this.emit('queueActive', queueId);\n  }\n\n  async abortQueue(queueId: string) {\n    this.logger.info(`Aborting queue ${queueId}`);\n    // Abort active jobs\n    const queueAbortControllerMap = this.abortControllerMap.get(queueId);\n    if (typeof queueAbortControllerMap !== 'undefined') {\n      for (const abortController of queueAbortControllerMap.values()) {\n        abortController.abort();\n      }\n    }\n    // Changes:\n    // * JOB_ERROR_STATUS -> JOB_CLEANUP_STATUS\n    // * JOB_COMPLETE_STATUS -> JOB_CLEANUP_STATUS\n    // * JOB_PENDING_STATUS -> JOB_ABORTED_STATUS\n    const jobs = await markQueueForCleanupInDatabase(queueId);\n    await this.startJobs(jobs);\n  }\n\n  dequeue():void | Promise<void> {\n    if (this.dequeueQueue.size === 0) {\n      // Add a subsequent dequeue\n      this.dequeueQueue.add(this.startJobs.bind(this));\n    }\n    return this.dequeueQueue.onIdle();\n  }\n\n  async startJobs(newJobs?:Array<Job>) { // eslint-disable-line consistent-return\n    const jobs = Array.isArray(newJobs) ? newJobs : await dequeueFromDatabaseNotIn([...this.jobIds.keys()]);\n    const queueIds = new Set();\n    for (const { id, queueId, args, type, status, attempt, startAfter } of jobs) {\n      if (this.jobIds.has(id)) {\n        continue;\n      }\n      // Pause queues before adding items into them to avoid starting things out of priority\n      if (!queueIds.has(queueId)) {\n        const queue = this.queueMap.get(queueId);\n        if (typeof queue !== 'undefined') {\n          queue.pause();\n        }\n        queueIds.add(queueId);\n      }\n      if (status === JOB_PENDING_STATUS) {\n        this.startJob(id, queueId, args, type, attempt + 1, startAfter);\n      } else if (status === JOB_ERROR_STATUS) {\n        this.startErrorHandler(id, queueId, args, type, attempt, startAfter);\n      } else if (status === JOB_CLEANUP_STATUS) {\n        this.startCleanup(id, queueId, args, type);\n      } else if (status === JOB_CLEANUP_AND_REMOVE_STATUS) {\n        this.startCleanup(id, queueId, args, type);\n      } else {\n        throw new Error(`Unknown job status ${status} in job ${id} of queue ${queueId}`);\n      }\n    }\n    for (const queueId of queueIds) {\n      const queue = this.queueMap.get(queueId);\n      if (typeof queue !== 'undefined') {\n        queue.start();\n      } else {\n        this.logger.error(`Unable to start queue ${queueId} after dequeue; queue does not exist`);\n      }\n    }\n  }\n\n  async onIdle(maxDuration?: number) {\n    if (typeof this.onIdlePromise === 'undefined') {\n      this.onIdlePromise = (async () => {\n        const timeout = typeof maxDuration === 'number' ? Date.now() + maxDuration : -1;\n        const start = Date.now();\n        while (true) { // eslint-disable-line no-constant-condition\n          if (timeout !== -1 && Date.now() > timeout) {\n            this.logger.warn(`Idle timeout after ${Date.now() - start}ms`);\n            break;\n          }\n          await this.dequeueQueue.onIdle();\n          for (const [queueId, queue] of this.queueMap) {\n            const interval = setInterval(() => {\n              this.logger.info(`Waiting on queue ${queueId}`);\n            }, 250);\n            await queue.onIdle();\n            clearInterval(interval);\n          }\n          const jobsInterval = setInterval(() => {\n            this.logger.info('Waiting on jobs');\n          }, 250);\n          const jobs = await dequeueFromDatabase();\n          clearInterval(jobsInterval);\n          if (jobs.length > 0) {\n            const interval = setInterval(() => {\n              this.logger.info('Waiting on dequeue');\n            }, 250);\n            await this.dequeue();\n            clearInterval(interval);\n            continue;\n          }\n          break;\n        }\n        delete this.onIdlePromise;\n        this.emit('idle');\n      })();\n    }\n    await this.onIdlePromise;\n  }\n\n  getAbortController(id:number, queueId:string) {\n    let queueAbortControllerMap = this.abortControllerMap.get(queueId);\n    if (typeof queueAbortControllerMap === 'undefined') {\n      queueAbortControllerMap = new Map();\n      this.abortControllerMap.set(queueId, queueAbortControllerMap);\n    }\n    const abortController = queueAbortControllerMap.get(id);\n    if (typeof abortController !== 'undefined') {\n      return abortController;\n    }\n    const newAbortController = new AbortController();\n    queueAbortControllerMap.set(id, newAbortController);\n    return newAbortController;\n  }\n\n  removeAbortController(id:number, queueId:string) {\n    const queueAbortControllerMap = this.abortControllerMap.get(queueId);\n    if (typeof queueAbortControllerMap === 'undefined') {\n      this.logger.warn(`Abort controller map for ${id} in queue ${queueId} does not exist`);\n      return;\n    }\n    const abortController = queueAbortControllerMap.get(id);\n    if (typeof abortController === 'undefined') {\n      this.logger.warn(`Abort controller for ${id} in queue ${queueId} does not exist`);\n      return;\n    }\n    queueAbortControllerMap.delete(id);\n    if (queueAbortControllerMap.size === 0) {\n      this.abortControllerMap.delete(queueId);\n    }\n  }\n\n  async runCleanup(id:number, queueId:string, args:Array<any>, type:string) {\n    this.emit('cleanupStart', { id });\n    const cleanup = this.cleanupMap.get(type);\n    if (typeof cleanup !== 'function') {\n      this.logger.warn(`No cleanup for job type ${type}`);\n      await removeCleanupFromDatabase(id);\n      this.emit('cleanup', { id });\n      return;\n    }\n    const cleanupJob = await getCleanupFromDatabase(id);\n    const { data, startAfter } = typeof cleanupJob === 'undefined' ? { data: undefined, startAfter: 0 } : cleanupJob;\n    const delay = startAfter - Date.now();\n    if (delay > 0) {\n      this.logger.info(`Delaying retry of ${type} job #${id} cleanup in queue ${queueId} by ${delay}ms to ${new Date(startAfter).toLocaleString()}`);\n      await new Promise((resolve) => setTimeout(resolve, delay));\n    }\n    try {\n      await cleanup(data, args, (path:Array<string>) => removePathFromCleanupDataInDatabase(id, path));\n    } catch (error) {\n      const attempt = await incrementCleanupAttemptInDatabase(id, queueId);\n      if (error.name === 'FatalCleanupError') {\n        this.logger.error(`Fatal error in ${type} job #${id} cleanup in queue ${queueId} attempt ${attempt}`);\n        this.emit('error', error);\n        await removeCleanupFromDatabase(id);\n        this.emit('fatalCleanupError', { id, queueId });\n        return;\n      }\n      const retryCleanupDelay = await this.getRetryCleanupDelay(type, attempt, error);\n      if (retryCleanupDelay === false) {\n        this.logger.error(`Error in ${type} job #${id} cleanup in queue ${queueId} attempt ${attempt} with no additional attempts requested`);\n        this.emit('error', error);\n        await removeCleanupFromDatabase(id);\n        this.emit('fatalCleanupError', { id, queueId });\n        return;\n      }\n      this.logger.error(`Error in ${type} job #${id} cleanup in queue ${queueId} attempt ${attempt}, retrying ${retryCleanupDelay > 0 ? `in ${retryCleanupDelay}ms'}` : 'immediately'}`);\n      this.emit('error', error);\n      if (retryCleanupDelay > 0) {\n        this.emit('retryCleanupDelay', { id, queueId, retryCleanupDelay });\n        const newStartAfter = Date.now() + retryCleanupDelay;\n        await markCleanupStartAfterInDatabase(id, newStartAfter);\n      }\n      await this.runCleanup(id, queueId, args, type);\n      return;\n    }\n    await removeCleanupFromDatabase(id);\n    this.emit('cleanup', { id });\n  }\n\n  startCleanup(id:number, queueId:string, args:Array<any>, type:string) {\n    this.logger.info(`Adding ${type} cleanup job #${id} to queue ${queueId}`);\n    this.jobIds.add(id);\n    const priority = PRIORITY_OFFSET + id;\n    const run = async () => {\n      this.logger.info(`Starting ${type} cleanup #${id} in queue ${queueId}`);\n      await this.runCleanup(id, queueId, args, type);\n      // Job could be marked for removal while cleanup is running\n      await markJobAsAbortedOrRemoveFromDatabase(id);\n      this.jobIds.delete(id);\n    };\n    this.addToQueue(queueId, priority, run);\n  }\n\n  startErrorHandler(id:number, queueId:string, args:Array<any>, type:string, attempt: number, startAfter: number) {\n    this.logger.info(`Adding ${type} error handler job #${id} to queue ${queueId}`);\n    this.jobIds.add(id);\n    const priority = PRIORITY_OFFSET + id;\n    const abortController = this.getAbortController(id, queueId);\n    const run = async () => {\n      this.logger.info(`Starting ${type} error handler #${id} in queue ${queueId}`);\n      await this.runCleanup(id, queueId, args, type);\n      if (abortController.signal.aborted) {\n        // Job could be marked for removal while error handler is running\n        await markJobAsAbortedOrRemoveFromDatabase(id);\n        this.removeAbortController(id, queueId);\n        this.jobIds.delete(id);\n      } else {\n        await markJobPendingInDatabase(id);\n        this.logger.info(`Retrying ${type} job #${id} in queue ${queueId}`);\n        this.emit('retry', { id });\n        this.startJob(id, queueId, args, type, attempt + 1, startAfter);\n      }\n    };\n    this.addToQueue(queueId, priority, run);\n  }\n\n  async delayJobStart(id:number, queueId:string, type:string, signal: AbortSignal, startAfter: number) {\n    if (signal.aborted) {\n      throw new AbortError(`Queue ${queueId} was aborted`);\n    }\n    const duration = startAfter - Date.now();\n    if (duration > 0) {\n      this.logger.info(`Delaying start of ${type} job #${id} in queue ${queueId} by ${duration}ms`);\n      await new Promise((resolve, reject) => {\n        const timeout = setTimeout(() => {\n          signal.removeEventListener('abort', handleAbort);\n          resolve();\n        }, duration);\n        const handleAbort = () => {\n          clearTimeout(timeout);\n          signal.removeEventListener('abort', handleAbort);\n          reject(new AbortError(`Queue ${queueId} was aborted`));\n        };\n        signal.addEventListener('abort', handleAbort);\n      });\n    }\n  }\n\n  startJob(id:number, queueId:string, args:Array<any>, type:string, attempt:number, startAfter: number) {\n    this.logger.info(`Adding ${type} job #${id} to queue ${queueId}`);\n    this.jobIds.add(id);\n    const priority = PRIORITY_OFFSET - id;\n    const updateCleanupData = (data:Object) => updateCleanupValuesInDatabase(id, queueId, data);\n    const abortController = this.getAbortController(id, queueId);\n    const run = async () => {\n      if (abortController.signal.aborted) {\n        this.emit('fatalError', { id, queueId, error: new AbortError(`Queue ${queueId} was aborted`) });\n        this.removeAbortController(id, queueId);\n        this.jobIds.delete(id);\n        return;\n      }\n      this.logger.info(`Starting ${type} job #${id} in queue ${queueId} attempt ${attempt}`);\n      const handler = this.handlerMap.get(type);\n      if (typeof handler !== 'function') {\n        this.logger.warn(`No handler for job type ${type}`);\n        await markJobCompleteInDatabase(id);\n        this.removeAbortController(id, queueId);\n        this.jobIds.delete(id);\n        return;\n      }\n      let handlerDidRun = false;\n      try {\n        // Mark as error in database so the job is cleaned up and retried if execution\n        // stops before job completion or error.\n        await markJobErrorInDatabase(id);\n        await this.delayJobStart(id, queueId, type, abortController.signal, startAfter);\n        handlerDidRun = true;\n        await handler(args, abortController.signal, updateCleanupData);\n        if (abortController.signal.aborted) {\n          throw new AbortError(`Queue ${queueId} was aborted`);\n        }\n        await markJobCompleteInDatabase(id);\n        this.removeAbortController(id, queueId);\n        this.jobIds.delete(id);\n        return;\n      } catch (error) {\n        if (error.name === 'JobDoesNotExistError') {\n          this.logger.error(`Job does not exist error for ${type} job #${id} in queue ${queueId} attempt ${attempt}`);\n          if (handlerDidRun) {\n            this.emit('fatalError', { id, queueId, error });\n            await restoreJobToDatabaseForCleanupAndRemove(id, queueId, type, args);\n            this.jobIds.delete(id);\n            this.removeAbortController(id, queueId);\n            this.startCleanup(id, queueId, args, type);\n          } else {\n            this.emit('fatalError', { id, queueId, error });\n            this.jobIds.delete(id);\n            this.removeAbortController(id, queueId);\n          }\n          return;\n        }\n        if (abortController.signal.aborted) {\n          if (error.name !== 'AbortError') {\n            this.logger.error(`Abort signal following error in ${type} job #${id} in queue ${queueId} attempt ${attempt}`);\n            this.emit('error', error);\n          } else {\n            this.logger.warn(`Received abort signal for ${type} job #${id} in queue ${queueId} attempt ${attempt}`);\n          }\n          if (handlerDidRun) {\n            this.emit('fatalError', { id, queueId, error });\n            this.jobIds.delete(id);\n            this.removeAbortController(id, queueId);\n            this.startCleanup(id, queueId, args, type);\n          } else {\n            this.emit('fatalError', { id, queueId, error });\n            await markJobAsAbortedOrRemoveFromDatabase(id);\n            this.jobIds.delete(id);\n            this.removeAbortController(id, queueId);\n          }\n          return;\n        }\n        await incrementJobAttemptInDatabase(id);\n        if (error.name === 'FatalError') {\n          this.logger.error(`Fatal error in ${type} job #${id} in queue ${queueId} attempt ${attempt}`);\n          this.emit('error', error);\n          this.emit('fatalError', { id, queueId, error });\n          this.jobIds.delete(id);\n          this.removeAbortController(id, queueId);\n          await this.abortQueue(queueId);\n          return;\n        }\n        const retryDelay = await this.getRetryJobDelay(type, attempt, error);\n        if (retryDelay === false) {\n          this.logger.error(`Error in ${type} job #${id} in queue ${queueId} attempt ${attempt} with no additional attempts requested`);\n          this.emit('error', error);\n          this.emit('fatalError', { id, queueId, error });\n          this.jobIds.delete(id);\n          this.removeAbortController(id, queueId);\n          await this.abortQueue(queueId);\n          return;\n        }\n        this.logger.error(`Error in ${type} job #${id} in queue ${queueId} attempt ${attempt}, retrying ${retryDelay > 0 ? `in ${retryDelay}ms'}` : 'immediately'}`);\n        this.emit('error', error);\n        if (retryDelay > 0) {\n          this.emit('retryDelay', { id, queueId, retryDelay });\n          const newStartAfter = Date.now() + retryDelay;\n          await markJobStartAfterInDatabase(id, newStartAfter);\n          this.jobIds.delete(id);\n          this.startErrorHandler(id, queueId, args, type, attempt, newStartAfter);\n        } else {\n          this.jobIds.delete(id);\n          this.startErrorHandler(id, queueId, args, type, attempt, startAfter);\n        }\n      }\n    };\n    this.addToQueue(queueId, priority, run);\n    this.emit('dequeue', { id });\n  }\n\n  async handlePortMessage(event:MessageEvent) {\n    if (!(event instanceof MessageEvent)) {\n      return;\n    }\n    const { data } = event;\n    if (!data || typeof data !== 'object') {\n      this.logger.warn('Invalid message data');\n      this.logger.warnObject(event);\n      return;\n    }\n    const { type, args } = data;\n    if (typeof type !== 'string') {\n      this.logger.warn('Unknown message type');\n      this.logger.warnObject(event);\n      return;\n    }\n    if (!Array.isArray(args)) {\n      this.logger.warn('Unknown arguments type');\n      this.logger.warnObject(event);\n      return;\n    }\n    const port = this.port;\n    switch (type) {\n      case 'unlink':\n        this.logger.warn('Unlinking worker interface');\n        if (port instanceof MessagePort) {\n          port.onmessage = null;\n          delete this.port;\n        }\n        return;\n      case 'heartbeat':\n        this.emit('heartbeat', ...args);\n        return;\n      case 'jobAdd':\n        jobEmitter.emit('jobAdd', ...args);\n        return;\n      case 'jobDelete':\n        jobEmitter.emit('jobDelete', ...args);\n        return;\n      case 'jobUpdate':\n        jobEmitter.emit('jobUpdate', ...args);\n        return;\n      case 'jobsClear':\n        jobEmitter.emit('jobsClear', ...args);\n        return;\n      default:\n        break;\n    }\n    const [requestId, ...requestArgs] = args;\n    if (typeof requestId !== 'number') {\n      throw new Error('Request arguments should start with a requestId number');\n    }\n    switch (type) {\n      case 'clear':\n        try {\n          await this.clear();\n          this.emit('clearComplete', requestId);\n        } catch (error) {\n          this.emit('clearError', requestId, error);\n          this.logger.error('Unable to handle clear message');\n          this.emit('error', error);\n        }\n        break;\n      case 'abortQueue':\n        try {\n          const [queueId] = requestArgs;\n          if (typeof queueId !== 'string') {\n            throw new Error(`Invalid \"queueId\" argument with type ${typeof queueId}, should be type string`);\n          }\n          await this.abortQueue(queueId);\n          this.emit('abortQueueComplete', requestId);\n        } catch (error) {\n          this.emit('abortQueueError', requestId, error);\n          this.logger.error('Unable to handle abort queue message');\n          this.emit('error', error);\n        }\n        break;\n      case 'dequeue':\n        try {\n          await this.dequeue();\n          this.emit('dequeueComplete', requestId);\n        } catch (error) {\n          this.emit('dequeueError', requestId, error);\n          this.logger.error('Unable to handle dequeue message');\n          this.emit('error', error);\n        }\n        break;\n      case 'enableStartOnJob':\n        try {\n          this.enableStartOnJob();\n          this.emit('enableStartOnJobComplete', requestId);\n        } catch (error) {\n          this.emit('enableStartOnJobError', requestId, error);\n          this.logger.error('Unable to handle enableStartOnJob message');\n          this.emit('error', error);\n        }\n        break;\n      case 'disableStartOnJob':\n        try {\n          this.disableStartOnJob();\n          this.emit('disableStartOnJobComplete', requestId);\n        } catch (error) {\n          this.emit('disableStartOnJobError', requestId, error);\n          this.logger.error('Unable to handle disableStartOnJob message');\n          this.emit('error', error);\n        }\n        break;\n      case 'getQueueIds':\n        try {\n          const queueIds = await this.getQueueIds();\n          this.emit('getQueuesComplete', requestId, [...queueIds]);\n        } catch (error) {\n          this.emit('getQueuesError', requestId, error);\n          this.logger.error('Unable to handle getQueueIds message');\n          this.emit('error', error);\n        }\n        break;\n      case 'idle':\n        try {\n          const [maxDuration, start] = requestArgs;\n          if (typeof maxDuration !== 'number') {\n            throw new Error(`Invalid \"queueId\" argument with type ${typeof maxDuration}, should be type number`);\n          }\n          if (typeof start !== 'number') {\n            throw new Error(`Invalid \"queueId\" argument with type ${typeof start}, should be type number`);\n          }\n          await this.onIdle(maxDuration - (Date.now() - start));\n          this.emit('idleComplete', requestId);\n        } catch (error) {\n          this.emit('idleError', requestId, error);\n          this.logger.error('Unable to handle idle message');\n          this.emit('error', error);\n        }\n        break;\n      default:\n        this.logger.warn(`Unknown worker interface message type ${type}`);\n    }\n  }\n\n  async unloadClient() {\n    this.logger.info('Detected client unload');\n    const heartbeatExpiresTimestamp = this.heartbeatExpiresTimestamp;\n    if (typeof heartbeatExpiresTimestamp !== 'number') {\n      return;\n    }\n    delete this.heartbeatExpiresTimestamp;\n    const delay = heartbeatExpiresTimestamp - Date.now();\n    if (delay > 0) {\n      await new Promise((resolve) => {\n        const timeout = setTimeout(() => {\n          clearTimeout(timeout);\n          this.removeListener('heartbeat', handleHeartbeat);\n          resolve();\n        }, delay);\n        const handleHeartbeat = () => {\n          clearTimeout(timeout);\n          this.removeListener('heartbeat', handleHeartbeat);\n          resolve();\n        };\n        this.addListener('heartbeat', handleHeartbeat);\n      });\n    }\n    if (typeof this.heartbeatExpiresTimestamp === 'number') {\n      this.logger.info('Cancelling client unload, heartbeat detected');\n      return;\n    }\n    this.logger.info('Unloading');\n    this.emit('unloadClient');\n  }\n\n  listenForServiceWorkerInterface() {\n    let activeEmitCallback;\n    let handleJobAdd;\n    let handleJobDelete;\n    let handleJobUpdate;\n    let handleJobsClear;\n\n    self.addEventListener('sync', (event) => {\n      this.logger.info(`SyncManager event ${event.tag}${event.lastChance ? ', last chance' : ''}`);\n      if (event.tag === 'syncManagerOnIdle') {\n        this.logger.info('Starting SyncManager idle handler');\n        this.emit('syncManagerOnIdle');\n        event.waitUntil(this.onIdle().catch((error) => {\n          this.logger.error(`SyncManager event handler failed${event.lastChance ? ' on last chance' : ''}`);\n          this.logger.errorStack(error);\n        }));\n      } else if (event.tag === 'unload') {\n        this.logger.info('Starting SyncManager unload client handler');\n        event.waitUntil(this.unloadClient().catch((error) => {\n          this.logger.error(`SyncManager event handler failed${event.lastChance ? ' on last chance' : ''}`);\n          this.logger.errorStack(error);\n        }));\n      } else {\n        this.logger.warn(`Received unknown SyncManager event tag ${event.tag}`);\n      }\n    });\n\n    self.addEventListener('message', (event:ExtendableMessageEvent) => {\n      if (!(event instanceof ExtendableMessageEvent)) {\n        return;\n      }\n      const { data } = event;\n      if (!data || typeof data !== 'object') {\n        return;\n      }\n      const { type } = data;\n      if (type !== 'BATTERY_QUEUE_WORKER_INITIALIZATION') {\n        return;\n      }\n      if (!Array.isArray(event.ports)) {\n        return;\n      }\n      const port = event.ports[0];\n      if (!(port instanceof MessagePort)) {\n        return;\n      }\n      this.emitCallbacks = this.emitCallbacks.filter((x) => x !== activeEmitCallback);\n      const previousPort = this.port;\n      if (previousPort instanceof MessagePort) {\n        this.logger.info('Closing previous worker interface');\n        previousPort.close();\n      }\n      if (typeof handleJobAdd === 'function') {\n        localJobEmitter.removeListener('jobAdd', handleJobAdd);\n      }\n      if (typeof handleJobDelete === 'function') {\n        localJobEmitter.removeListener('jobDelete', handleJobDelete);\n      }\n      if (typeof handleJobUpdate === 'function') {\n        localJobEmitter.removeListener('jobUpdate', handleJobUpdate);\n      }\n      if (typeof handleJobsClear === 'function') {\n        localJobEmitter.removeListener('jobsClear', handleJobsClear);\n      }\n      port.postMessage({ type: 'BATTERY_QUEUE_WORKER_CONFIRMATION' });\n      this.logger.info('Linked to worker interface');\n      port.onmessage = this.handlePortMessage.bind(this);\n\n      handleJobAdd = (...args:Array<any>) => {\n        port.postMessage({ type: 'jobAdd', args });\n      };\n      handleJobDelete = (...args:Array<any>) => {\n        port.postMessage({ type: 'jobDelete', args });\n      };\n      handleJobUpdate = (...args:Array<any>) => {\n        port.postMessage({ type: 'jobUpdate', args });\n      };\n      handleJobsClear = (...args:Array<any>) => {\n        port.postMessage({ type: 'jobsClear', args });\n      };\n      localJobEmitter.addListener('jobAdd', handleJobAdd);\n      localJobEmitter.addListener('jobDelete', handleJobDelete);\n      localJobEmitter.addListener('jobUpdate', handleJobUpdate);\n      localJobEmitter.addListener('jobsClear', handleJobsClear);\n      const emitCallback = (t:string, args:Array<any>) => {\n        port.postMessage({ type: t, args });\n      };\n      activeEmitCallback = emitCallback;\n      this.emitCallbacks.push(emitCallback);\n      this.port = port;\n    });\n    self.addEventListener('messageerror', (event:MessageEvent) => {\n      this.logger.error('Service worker interface message error');\n      this.logger.errorObject(event);\n    });\n  }\n}\n\n"],"file":"queue.js"}